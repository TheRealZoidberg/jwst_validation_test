
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging &#8212; Notebook repository template</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../../../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../../../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" href="../../../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/main.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/clipboard.min.js"></script>
    <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../../../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <link rel="next" title="JWST Pipeline Validation Notebook: outlier_detection with MIRI" href="../../outlier_detection/jwst_outlier_detection_miri_test/exec_jwst_outlier_detection_miri_test.html" />
    <link rel="prev" title="JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging" href="exec_jwst_tweakreg_miri_test.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../../_static/logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Notebook repository template</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../../../index.html">
                    <no title>
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../background/jwst_background_miri_test/jwst_background_subtraction_miri_imaging_testing.html">
   JWST Pipeline Validation Notebook: calwebb_image2, background subtraction for MIRI imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../background/jwst_background_miri_test/exec_jwst_background_subtraction_miri_imaging_testing.html">
   JWST Pipeline Validation Notebook: calwebb_image2, background subtraction for MIRI imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../background/jwst_background_miri_test/exec_background_sub-miri-lrs-slit.html">
   JWST Pipeline Validation Testing Notebook: Background_subtract() for MIRI LRS SLIT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../background/jwst_background_miri_test/background_sub-miri-lrs-slit.html">
   JWST Pipeline Validation Testing Notebook: Background_subtract() for MIRI LRS SLIT
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../pathloss/jwst_pathloss_nirspec_test/exec_jwst_pathloss_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, pathloss step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../pathloss/jwst_pathloss_nirspec_test/jwst_pathloss_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, pathloss step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../msaflagopen/jwst_msa_flagging_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, msa_flagging step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../msaflagopen/exec_jwst_msa_flagging_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, msa_flagging step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../resample/jwst_resample_miri_test/jwst_resample_miri_lrs_slit.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Resample step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../resample/jwst_resample_miri_test/exec_jwst_resample_miri_lrs_slit.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Resample step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../resample/jwst_resample_miri_test/jwst_resample_miri_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Resample step with MIRI imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../resample/jwst_resample_miri_test/exec_jwst_resample_miri_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Resample step with MIRI imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../example_notebook/example_notebook.html">
   Draft: Notebook title
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source_catalog/jwst_source_catalog_miri_test/exec_jwst_source_catalog_miri_test.html">
   JWST Pipeline Validation Notebook: calwebb_image3: source_catalog with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source_catalog/jwst_source_catalog_miri_test/jwst_source_catalog_miri_test.html">
   JWST Pipeline Validation Notebook: calwebb_image3: source_catalog with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source_catalog/jwst_source_catalog_nircam_test/jwst_nircam_imaging_source_catalog.html">
   JWST Pipeline Validation Notebook: NIRCam, calwebb_image3, source_catalog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../source_catalog/jwst_source_catalog_nircam_test/exec_jwst_nircam_imaging_source_catalog.html">
   JWST Pipeline Validation Notebook: NIRCam, calwebb_image3, source_catalog
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../lastframe/exec_jwst_lastframe_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, lastframe unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../lastframe/jwst_lastframe_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, lastframe unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../photom/jwst_photom_miri_test/exec_photom_miri_lrs_slitless.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slitless spectroscopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../photom/jwst_photom_miri_test/photom_miri_mrs_test.html">
   JWST Pipeline Validation Testing Notebook: Spec2, photom, MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../photom/jwst_photom_miri_test/exec_photom_miri_lrs_slit.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slit spectroscopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../photom/jwst_photom_miri_test/exec_photom_miri_mrs_test.html">
   JWST Pipeline Validation Testing Notebook: Spec2, photom, MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../photom/jwst_photom_miri_test/photom_miri_lrs_slit.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slit spectroscopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../photom/jwst_photom_miri_test/photom_miri_lrs_slitless.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slitless spectroscopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../photom/jwst_photom_miri_test/exec_jwst_photom_miri_test.html">
   JWST Pipeline Validation Notebook: photom with MIRI Imager
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../photom/jwst_photom_miri_test/jwst_photom_miri_test.html">
   JWST Pipeline Validation Notebook: photom with MIRI Imager
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ami3/run_ami_pipeline.html">
   JWST Pipeline Validation Notebook:  AMI3, AMI3 Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ami3/exec_ami_analyze_verify.html">
   JWST Pipeline Validation Notebook: AMI3, AmiAnalyze
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ami3/exec_ami_average.html">
   JWST Pipeline Validation Notebook:  calwebb_ami3, ami_average
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ami3/exec_ami_normalize.html">
   JWST Pipeline Validation Notebook: calwebb_ami3, ami_normalize
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ami3/exec_run_ami_pipeline.html">
   JWST Pipeline Validation Notebook:  AMI3, AMI3 Pipeline
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ami3/ami_normalize.html">
   JWST Pipeline Validation Notebook: calwebb_ami3, ami_normalize
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ami3/ami_average.html">
   JWST Pipeline Validation Notebook:  calwebb_ami3, ami_average
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ami3/ami_analyze_verify.html">
   JWST Pipeline Validation Notebook: AMI3, AmiAnalyze
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_nirspec_test/jwst_assign_wcs_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: NIRSpec, spec2, assign_wcs step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_nirspec_test/exec_jwst_assign_wcs_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: NIRSpec, spec2, assign_wcs step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_niriss_test/jwst_assign_wcs_niriss_image.html">
   JWST Pipeline Validation Notebook: NIRISS, image2, assign_wcs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_niriss_test/exec_jwst_assign_wcs_niriss_image.html">
   JWST Pipeline Validation Notebook: NIRISS, image2, assign_wcs
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_miri_test/exec_assign_wcs-miri-mrs.html">
   JWST Pipeline Validation Testing Notebook: MIRI MRS Spec2: Assign_wcs()
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_miri_test/exec_assign_wcs-miri-lrs-tso.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Time Series Observation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_miri_test/assign_wcs-miri-lrs-slit.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_miri_test/assign_wcs-miri-mrs.html">
   JWST Pipeline Validation Testing Notebook: MIRI MRS Spec2: Assign_wcs()
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_miri_test/assign_wcs-miri-lrs-tso.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Time Series Observation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../assign_wcs/jwst_assign_wcs_miri_test/exec_assign_wcs-miri-lrs-slit.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../barshadow/jwst_barshadow_nirspec_test/jwst_barshadow_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, barshadow step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../barshadow/jwst_barshadow_nirspec_test/exec_jwst_barshadow_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, barshadow step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reset/jwst_reset_miri_test/exec_jwst_reset_miri_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_detector1, reset step for MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../reset/jwst_reset_miri_test/jwst_reset_miri_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_detector1, reset step for MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../refpix/jwst_refpix_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, refpix unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../refpix/exec_jwst_refpix_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, refpix unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_nirspec_test/jwst_flat_field_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, flat_field step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_nirspec_test/exec_jwst_flat_field_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, flat_field step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_miri_test/exec_flatfield_analysis_slitless.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slitless spectroscopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_miri_test/exec_jwst_flat_field_miri_test.html">
   JWST Pipeline Validation Testing notebook: flat_field step with MIRI Imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_miri_test/exec_flat-miri-lrs-slit.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slit spectroscopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_miri_test/flatfield_analysis_slitless.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slitless spectroscopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_miri_test/exec_flat_miri_mrs_test.html">
   JWST Pipeline Validation Testing Notebook: Spec2, flat_field, MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_miri_test/flat-miri-lrs-slit.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slit spectroscopy
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_miri_test/jwst_flat_field_miri_test.html">
   JWST Pipeline Validation Testing notebook: flat_field step with MIRI Imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../flat_field/jwst_flat_field_miri_test/flat_miri_mrs_test.html">
   JWST Pipeline Validation Testing Notebook: Spec2, flat_field, MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../skymatch/jwst_skymatch_miri_test/jwst_skymatch_photom_miri_test.html">
   JWST Pipeline Validation Notebook: skymatch and photometry with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../skymatch/jwst_skymatch_miri_test/exec_jwst_skymatch_miri_test.html">
   JWST Pipeline Validation Notebook: skymatch with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../skymatch/jwst_skymatch_miri_test/exec_jwst_skymatch_photom_miri_test.html">
   JWST Pipeline Validation Notebook: skymatch and photometry with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../skymatch/jwst_skymatch_miri_test/jwst_skymatch_miri_test.html">
   JWST Pipeline Validation Notebook: skymatch with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../jump/jwst_jump_miri_test/jwst_jump_miri_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Detector1, Jump step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../jump/jwst_jump_miri_test/exec_jwst_jump_miri_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Detector1, Jump step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../jump/jwst_jump_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, jump unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../jump/exec_jwst_jump_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, jump unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_image3/jwst_image3_nircam_test/jwst_image3_nircam_test.html">
   JWST Pipeline Validation Notebook: calwebb_image3, NIRCam imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_image3/jwst_image3_nircam_test/exec_jwst_image3_nircam_test.html">
   JWST Pipeline Validation Notebook: calwebb_image3, NIRCam imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_image3/jwst_image3_miri_test/exec_jwst_image3_miri_test.html">
   JWST Pipeline Validation Notebook: calwebb_image3 with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_image3/jwst_image3_miri_test/jwst_image3_miri_test.html">
   JWST Pipeline Validation Notebook: calwebb_image3 with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_detector1/jwst_detector1_nircam_test/jwst_detector1_nircam_test.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, NIRCam imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_detector1/jwst_detector1_nircam_test/exec_jwst_detector1_nircam_test.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, NIRCam imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_detector1/jwst_detector1_miri_test/exec_jwst_detector1_miri_imtso_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Detector1 for MIRI TSO imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_detector1/jwst_detector1_miri_test/jwst_detector1_miri_imtso_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Detector1 for MIRI TSO imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_detector1/jwst_detector1_miri_test/exec_caldetector1-miri-lrs-tso.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Time Series Observation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_detector1/jwst_detector1_miri_test/caldetector1-miri-lrs-tso.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Time Series Observation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rscd/jwst_rscd_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, rscd unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rscd/exec_jwst_rscd_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, rscd unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rscd/jwst_rscd_miri_test/exec_jwst_miri_rscd_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Detector1, RSCD step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../rscd/jwst_rscd_miri_test/jwst_miri_rscd_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Detector1, RSCD step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_image2/jwst_image2_nircam_test/jwst_image2_nircam_test.html">
   JWST Pipeline Validation Notebook: calwebb_image2, NIRCam imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_image2/jwst_image2_nircam_test/exec_jwst_image2_nircam_test.html">
   JWST Pipeline Validation Notebook: calwebb_image2, NIRCam imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ramp_fitting/exec_jwst_ramp_fitting_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, ramp_fitting unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ramp_fitting/jwst_ramp_fitting_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, ramp_fitting unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../firstframe/exec_jwst_firstframe_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, firstframe unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../firstframe/jwst_firstframe_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, firstframe unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../dq_init/exec_jwst_dq_init_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, dq_init unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../dq_init/jwst_dq_init_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, dq_init unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../cube_build/jwst_cube_build_miri_test/test_cube_build_spec3.html">
   JWST Pipeline Validation Testing Notebook: Cube Build with MIRISIM Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../cube_build/jwst_cube_build_miri_test/exec_testing_point_source_flux_conservation_modeshep_all.html">
   JWST Pipeline Validation Testing Notebook: Point Source Flux Conservation Modeshep
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../cube_build/jwst_cube_build_miri_test/testing_point_source_flux_conservation_modeshep_all.html">
   JWST Pipeline Validation Testing Notebook: Point Source Flux Conservation Modeshep
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../cube_build/jwst_cube_build_miri_test/exec_test_cube_build_spec3.html">
   JWST Pipeline Validation Testing Notebook: Cube Build with MIRISIM Data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../saturation/exec_jwst_saturation_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, saturation unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../saturation/jwst_saturation_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, saturation unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../extract_2d/jwst_extract_2d_nirspec_test/jwst_extract_2d_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, extract_2d step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../extract_2d/jwst_extract_2d_nirspec_test/exec_jwst_extract_2d_nirspec_test.html">
   JWST Pipeline Validation Testing Notebook: spec2, extract_2d step
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../persistence/exec_jwst_persistence_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, persistence unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../persistence/jwst_persistence_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, persistence unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../extract_1d/jwst_extract_1d_miri_test/exec_extract_1d-spec2-miri-lrs-slit.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../extract_1d/jwst_extract_1d_miri_test/extract_1d-spec2-miri-lrs-slitless.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slitless
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../extract_1d/jwst_extract_1d_miri_test/extract_1d-spec2-miri-lrs-slit.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slit
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../extract_1d/jwst_extract_1d_miri_test/exec_extract_1d-spec2-miri-lrs-slitless.html">
   JWST Pipeline Validation Testing Notebook: MIRI LRS Slitless
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../dark_current/exec_jwst_dark_current_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, dark_current unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../dark_current/jwst_dark_current_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, dark_current unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../templates/jwst_validation_notebook_template.html">
   JWST Pipeline Validation Notebook:
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../templates/exec_jwst_validation_notebook_template.html">
   JWST Pipeline Validation Notebook:
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../templates/validation_test_template.html">
   JWST Pipeline Validation Testing Notebook: Descriptive Name of Test You Are Performing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../templates/exec_validation_test_template.html">
   JWST Pipeline Validation Testing Notebook: Descriptive Name of Test You Are Performing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ipc/exec_jwst_ipc_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, ipc unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../ipc/jwst_ipc_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, ipc unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/background/exec_jwst_background_unit_tests.html">
   JWST calwebb_image2, background unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/background/jwst_background_unit_tests.html">
   JWST calwebb_image2, background unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/jwst_nirspec_regression_tests.html">
   JWST NIRSpec regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/flatfield/exec_jwst_flatfield_unit_tests.html">
   JWST calwebb_image2 and calwebb_spec2, flatfield unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/flatfield/jwst_flatfield_unit_tests.html">
   JWST calwebb_image2 and calwebb_spec2, flatfield unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/jwst_nircam_regression_tests.html">
   JWST NIRCam regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/resample/exec_jwst_resample_unit_tests.html">
   JWST calwebb_image2 and calwebb_spec2, resample unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/resample/jwst_resample_unit_tests.html">
   JWST calwebb_image2 and calwebb_spec2, resample unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/jwst_niriss_regression_tests.html">
   JWST NIRISS regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/source_catalog/jwst_source_catalog_unit_tests.html">
   JWST calwebb_image3, source_catalog unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/source_catalog/exec_jwst_source_catalog_unit_tests.html">
   JWST calwebb_image3, source_catalog unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/exec_jwst_fgs_regression_tests.html">
   JWST FGS regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/photom/jwst_photom_unit_tests.html">
   JWST calwebb_image2 and calwebb_spec2, photom unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/photom/exec_jwst_photom_unit_tests.html">
   JWST calwebb_image2 and calwebb_spec2, photom unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/assign_wcs/jwst_assign_wcs_unit_tests.html">
   JWST calwebb_image2 and calwebb_spec2, assign_wcs unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/assign_wcs/exec_jwst_assign_wcs_unit_tests.html">
   JWST calwebb_image2 and calwebb_spec2, assign_wcs unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/skymatch/jwst_skymatch_unit_tests.html">
   JWST calwebb_image3, skymatch unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/skymatch/exec_jwst_skymatch_unit_tests.html">
   JWST calwebb_image3, skymatch unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/exec_jwst_niriss_regression_tests.html">
   JWST NIRISS regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/exec_jwst_nirspec_regression_tests.html">
   JWST NIRSpec regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/exec_jwst_nircam_regression_tests.html">
   JWST NIRCam regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/jwst_fgs_regression_tests.html">
   JWST FGS regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/exec_jwst_miri_regression_tests.html">
   JWST MIRI regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/jwst_miri_regression_tests.html">
   JWST MIRI regression tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/tweakreg/exec_jwst_tweakreg_unit_tests.html">
   JWST calwebb_image3, tweakreg unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/tweakreg/jwst_tweakreg_unit_tests.html">
   JWST calwebb_image3, tweakreg unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/outlier_detection/jwst_outlier_detection_unit_tests.html">
   JWST calwebb_image3, calwebb_spec3, calwebb_coron3, calwebb_tso3, outlier_detection unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../regression_test/outlier_detection/exec_jwst_outlier_detection_unit_tests.html">
   JWST calwebb_image3, calwebb_spec3, calwebb_coron3, calwebb_tso3, outlier_detection unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="exec_jwst_tweakreg_miri_test.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../outlier_detection/jwst_outlier_detection_miri_test/exec_jwst_outlier_detection_miri_test.html">
   JWST Pipeline Validation Notebook: outlier_detection with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../outlier_detection/jwst_outlier_detection_miri_test/exec_jwst_outlier_detection_view_miri_test.html">
   JWST Pipeline Validation Notebook: MIRI view outlier_detection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../outlier_detection/jwst_outlier_detection_miri_test/exec_out_det_test2.html">
   JWST Pipeline Validation Notebook: Outlier Detection for MIRI MRS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../outlier_detection/jwst_outlier_detection_miri_test/out_det_test2.html">
   JWST Pipeline Validation Notebook: Outlier Detection for MIRI MRS
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../outlier_detection/jwst_outlier_detection_miri_test/jwst_outlier_detection_miri_test.html">
   JWST Pipeline Validation Notebook: outlier_detection with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../outlier_detection/jwst_outlier_detection_miri_test/jwst_outlier_detection_view_miri_test.html">
   JWST Pipeline Validation Notebook: MIRI view outlier_detection
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../superbias/exec_jwst_superbias_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, superbias unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../superbias/jwst_superbias_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, superbias unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_coron3/exec_MIRI_shared_calcoron3_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Coron3 for MIRI Coronagraphic Imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_coron3/jwst_calcoron3_nircam_test.html">
   JWST Pipeline Validation Notebook: calwebb_coron3 with NIRCam
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_coron3/exec_jwst_calcoron3_nircam_test.html">
   JWST Pipeline Validation Notebook: calwebb_coron3 with NIRCam
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../calwebb_coron3/MIRI_shared_calcoron3_testing.html">
   JWST Pipeline Validation Testing Notebook: Calwebb_Coron3 for MIRI Coronagraphic Imaging
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fringe/JWST_fringe_miri_test/exec_fringe_miri_mrs_test.html">
   JWST Pipeline Validation Testing Notebook: Spec2, fringe, MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../fringe/JWST_fringe_miri_test/fringe_miri_mrs_test.html">
   JWST Pipeline Validation Testing Notebook: Spec2, fringe, MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../image3/jwst_image3_miri_test/exec_jwst_image3_miri_test.html">
   JWST Pipeline Validation Notebook: calwebb_image3 with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../image3/jwst_image3_miri_test/jwst_image3_miri_test.html">
   JWST Pipeline Validation Notebook: calwebb_image3 with MIRI
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../linearity/jwst_linearity_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, linearity unit tests
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../linearity/exec_jwst_linearity_unit_tests.html">
   JWST Pipeline Validation Notebook: calwebb_detector1, linearity unit tests
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/TheRealZoidberg/jwst_validation_test/main?urlpath=tree/notebooks/tweakreg/jwst_tweakreg_miri_test/jwst_tweakreg_miri_test.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../../_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
      <li>
        <a href="https://colab.research.google.com/github/TheRealZoidberg/jwst_validation_test/blob/main/notebooks/tweakreg/jwst_tweakreg_miri_test/jwst_tweakreg_miri_test.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Colab"
>
  

<span class="headerbtn__icon-container">
  
    <img src="../../../_static/images/logo_colab.png">
  </span>
<span class="headerbtn__text-container">Colab</span>
</a>

      </li>
      
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-repository-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Source repositories">
      <i class="fab fa-github"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://github.com/TheRealZoidberg/jwst_validation_test"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Source repository"
>
  

<span class="headerbtn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="headerbtn__text-container">repository</span>
</a>

      </li>
      
      <li>
        <a href="https://github.com/TheRealZoidberg/jwst_validation_test/issues/new?title=Issue%20on%20page%20%2Fnotebooks/tweakreg/jwst_tweakreg_miri_test/jwst_tweakreg_miri_test.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="headerbtn__text-container">open issue</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../../../_sources/notebooks/tweakreg/jwst_tweakreg_miri_test/jwst_tweakreg_miri_test.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#table-of-contents">
     Table of Contents
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calibration-wg-requested-algorithm">
     Calibration WG Requested Algorithm:
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#defining-terms">
     Defining Terms
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#description-of-test">
     Description of test
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#description-of-data">
     Description of data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-temporary-directory-to-work-in-and-read-in-data">
     Create a temporary directory to work in and read in data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-calwebb-detector1-pipeline-to-get-rate-fits-files">
     Run the calwebb_detector1 pipeline to get rate.fits files.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-calwebb-image2-pipeline-to-create-cal-fits-files">
     Run calwebb_image2 pipeline to create cal.fits files
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-1-see-what-happens-with-tweakreg-when-given-data-with-no-shifts">
     Test # 1: See what happens with tweakreg when given data with no shifts.
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#run-the-images-through-calwebb-image3-with-tweakreg-on">
       Run the images through calwebb_image3 with tweakreg on
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#go-through-list-of-individual-images-and-see-which-sources-were-found-for-each-image">
       Go through list of individual images and see which sources were found for each image.
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#get-position-differences-as-found-earlier-for-the-individual-i2d-files">
       Get position differences as found earlier for the individual i2d files
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#look-at-positions-of-ra-dec-and-get-stats-on-differences-for-the-combined-image-run-with-tweakreg-on">
       Look at positions of RA, Dec and get stats on differences for the combined image run with tweakreg on
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#run-calwebb-image3-with-tweakreg-turned-off">
       Run calwebb_image3 with tweakreg turned off
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-2-see-what-happens-with-tweakreg-when-there-are-shifts-between-images-not-tracked-in-the-wcs">
     Test # 2: See what happens with tweakreg when there are shifts between images not tracked in the wcs.
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Run the images through calwebb_image3 with tweakreg on
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Go through list of individual images and see which sources were found for each image.
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Look at positions of RA, Dec and get stats on differences for the combined image run with tweakreg on
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#test-again-with-tweakreg-off">
       Test again with tweakreg off
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#criteria-for-success">
       Criteria for success.
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#about-this-notebook">
         About this Notebook
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#table-of-contents">
     Table of Contents
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#calibration-wg-requested-algorithm">
     Calibration WG Requested Algorithm:
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#defining-terms">
     Defining Terms
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#description-of-test">
     Description of test
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#description-of-data">
     Description of data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#create-a-temporary-directory-to-work-in-and-read-in-data">
     Create a temporary directory to work in and read in data
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-calwebb-detector1-pipeline-to-get-rate-fits-files">
     Run the calwebb_detector1 pipeline to get rate.fits files.
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-calwebb-image2-pipeline-to-create-cal-fits-files">
     Run calwebb_image2 pipeline to create cal.fits files
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-1-see-what-happens-with-tweakreg-when-given-data-with-no-shifts">
     Test # 1: See what happens with tweakreg when given data with no shifts.
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#run-the-images-through-calwebb-image3-with-tweakreg-on">
       Run the images through calwebb_image3 with tweakreg on
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#go-through-list-of-individual-images-and-see-which-sources-were-found-for-each-image">
       Go through list of individual images and see which sources were found for each image.
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#get-position-differences-as-found-earlier-for-the-individual-i2d-files">
       Get position differences as found earlier for the individual i2d files
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#look-at-positions-of-ra-dec-and-get-stats-on-differences-for-the-combined-image-run-with-tweakreg-on">
       Look at positions of RA, Dec and get stats on differences for the combined image run with tweakreg on
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#run-calwebb-image3-with-tweakreg-turned-off">
       Run calwebb_image3 with tweakreg turned off
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#test-2-see-what-happens-with-tweakreg-when-there-are-shifts-between-images-not-tracked-in-the-wcs">
     Test # 2: See what happens with tweakreg when there are shifts between images not tracked in the wcs.
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id1">
       Run the images through calwebb_image3 with tweakreg on
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id2">
       Go through list of individual images and see which sources were found for each image.
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#id3">
       Look at positions of RA, Dec and get stats on differences for the combined image run with tweakreg on
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#test-again-with-tweakreg-off">
       Test again with tweakreg off
      </a>
     </li>
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#criteria-for-success">
       Criteria for success.
      </a>
      <ul class="nav section-nav flex-column">
       <li class="toc-h4 nav-item toc-entry">
        <a class="reference internal nav-link" href="#about-this-notebook">
         About this Notebook
        </a>
       </li>
      </ul>
     </li>
    </ul>
   </li>
  </ul>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <p><a id="title_ID"></a></p>
<section class="tex2jax_ignore mathjax_ignore" id="jwst-pipeline-validation-testing-notebook-calwebb-image3-tweakreg-step-with-miri-imaging">
<h1>JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging<a class="headerlink" href="#jwst-pipeline-validation-testing-notebook-calwebb-image3-tweakreg-step-with-miri-imaging" title="Permalink to this headline">#</a></h1>
<p><span style="color:red"> <strong>Instruments Affected</strong></span>: FGS, MIRI, NIRCam, NIRISS</p>
<p>Tested on MIRI Simulated data</p>
<section id="table-of-contents">
<h2>Table of Contents<a class="headerlink" href="#table-of-contents" title="Permalink to this headline">#</a></h2>
<div style="text-align: left"> 
<p><br>  <a class="reference external" href="#intro_ID">Introduction</a> <br> <a class="reference external" href="#pipeline_ID">Run JWST Pipelines</a> <br> <a class="reference external" href="#imports_ID">Imports</a> <br> <a class="reference external" href="#runpipeline_ID">Create an association table for your cal files and run them through calwebb_image3</a> <br> <a class="reference external" href="#runscript_ID">Find Stars in Image and Determine their Coordinates</a> <br> <a class="reference external" href="#residual_ID">Compare RA and Dec to expected Values</a> <br> <a class="reference external" href="#about_ID">About This Notebook</a> <br></p>
</div><p><a id="intro_ID"></a></p>
</section>
</section>
<section class="tex2jax_ignore mathjax_ignore" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">#</a></h1>
<p>This test is designed to test the tweakreg step in the calwebb_image3 pipeline. At the start of the calwebb_image3 pipeline, the shifts between the images in an association table are found. This step creates image catalogs of point-like sources whose centroids are then used to compute corrections to the WCS of the input images such that sky catalogs obtained from the image catalogs using the corrected WCS will align on the sky.</p>
<p>For more information on the pipeline step visit the links below.</p>
<p>Step description: <a class="reference external" href="https://jwst-pipeline.readthedocs.io/en/latest/jwst/tweakreg/README.html">https://jwst-pipeline.readthedocs.io/en/latest/jwst/tweakreg/README.html</a></p>
<p>Pipeline code: <a class="reference external" href="https://github.com/spacetelescope/jwst/tree/master/jwst/tweakreg">https://github.com/spacetelescope/jwst/tree/master/jwst/tweakreg</a></p>
<p>The data for this test were created with the MIRI Data Simulator, and the documentation for that code can be found here: <a class="reference external" href="http://miri.ster.kuleuven.be/bin/view/Public/MIRISim_Public">http://miri.ster.kuleuven.be/bin/view/Public/MIRISim_Public</a></p>
<section id="calibration-wg-requested-algorithm">
<h2>Calibration WG Requested Algorithm:<a class="headerlink" href="#calibration-wg-requested-algorithm" title="Permalink to this headline">#</a></h2>
<p>A short description and link to the page: <a class="reference external" href="https://outerspace.stsci.edu/display/JWSTCC/Vanilla+Refine+WCS">https://outerspace.stsci.edu/display/JWSTCC/Vanilla+Refine+WCS</a></p>
</section>
<section id="defining-terms">
<h2>Defining Terms<a class="headerlink" href="#defining-terms" title="Permalink to this headline">#</a></h2>
<p>Definition of terms or acronymns.</p>
<p>JWST: James Webb Space Telescope</p>
<p>MIRI: Mid-Infrared Instrument</p>
<p>MIRISim: MIRI Data Simulator</p>
</section>
<section id="description-of-test">
<h2>Description of test<a class="headerlink" href="#description-of-test" title="Permalink to this headline">#</a></h2>
<p>This test is performed by creating a set of simulated data with multiple point sources located at specified coordinates. The simulator puts in the expected distortion, so the initial output data comes out of the simulator in distorted coordinates. When this data is then run through calwebb_detector1, calwebb_image2 and calwebbb_image3, the combined, undistorted image should have the point sources registered at the expected locations. In flight, this test can be repeated with known stars that should be found at their expected coordinates. If there is a shift in coordinates between the images that was not expected, tweakreg will find the sources to create a better image alignment. This is checked by using DAOStarFinder to find the point sources in each image (individual and combined) so that the catalogs can be compared to the expected RA and Dec values that were used to create the images. The user will look at whether the statistics of the combined sources are better or worse than those of the individual images.</p>
</section>
<section id="description-of-data">
<h2>Description of data<a class="headerlink" href="#description-of-data" title="Permalink to this headline">#</a></h2>
<p>The data used in this simulation were created with the MIRISim simulator.</p>
<p>The simulation consists of eight files, two exposures each at four different dither positions. The images used in this test have 50 bright point sources scattered across the images, and were created in the F1130W filter.</p>
<p><a class="reference external" href="#title_ID">Top of Page</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="k">if</span> <span class="s1">&#39;CRDS_CACHE_TYPE&#39;</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_CACHE_TYPE&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;local&#39;</span><span class="p">:</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;HOME&#39;</span><span class="p">],</span> <span class="s1">&#39;crds&#39;</span><span class="p">,</span> <span class="s1">&#39;cache&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_CACHE_TYPE&#39;</span><span class="p">]):</span>
        <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_CACHE_TYPE&#39;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CRDS cache location: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyError</span><span class="g g-Whitespace">                                  </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">line</span> <span class="mi">7</span>
<span class="g g-Whitespace">      </span><span class="mi">5</span>     <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_CACHE_TYPE&#39;</span><span class="p">]):</span>
<span class="g g-Whitespace">      </span><span class="mi">6</span>         <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_CACHE_TYPE&#39;</span><span class="p">]</span>
<span class="ne">----&gt; </span><span class="mi">7</span> <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;CRDS cache location: </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;CRDS_PATH&#39;</span><span class="p">]))</span>

<span class="nn">File /usr/share/miniconda/lib/python3.9/os.py:679,</span> in <span class="ni">_Environ.__getitem__</span><span class="nt">(self, key)</span>
<span class="g g-Whitespace">    </span><span class="mi">676</span>     <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_data</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encodekey</span><span class="p">(</span><span class="n">key</span><span class="p">)]</span>
<span class="g g-Whitespace">    </span><span class="mi">677</span> <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">678</span>     <span class="c1"># raise KeyError with the original key value</span>
<span class="ne">--&gt; </span><span class="mi">679</span>     <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="kn">from</span> <span class="bp">None</span>
<span class="g g-Whitespace">    </span><span class="mi">680</span> <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">decodevalue</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

<span class="ne">KeyError</span>: &#39;CRDS_PATH&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># set up import statements</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">ascii</span><span class="p">,</span> <span class="n">fits</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">sigma_clipped_stats</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">astropy.visualization</span> <span class="kn">import</span> <span class="n">SqrtStretch</span>
<span class="kn">from</span> <span class="nn">astropy.visualization.mpl_normalize</span> <span class="kn">import</span> <span class="n">ImageNormalize</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">table</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">astropy.units</span> <span class="k">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.coordinates</span> <span class="kn">import</span> <span class="n">SkyCoord</span><span class="p">,</span> <span class="n">match_coordinates_sky</span>

<span class="c1">#from ci_watson.artifactory_helpers import get_bigdata</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">product</span>
<span class="kn">from</span> <span class="nn">ci_watson.artifactory_helpers</span> <span class="kn">import</span> <span class="n">get_bigdata</span>

<span class="c1"># Box download imports </span>
<span class="kn">from</span> <span class="nn">astropy.utils.data</span> <span class="kn">import</span> <span class="n">download_file</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>
<span class="kn">from</span> <span class="nn">shutil</span> <span class="kn">import</span> <span class="n">move</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">splitext</span>

<span class="kn">from</span> <span class="nn">jwst.datamodels</span> <span class="kn">import</span> <span class="n">DrizProductModel</span><span class="p">,</span> <span class="n">ImageModel</span>
<span class="kn">from</span> <span class="nn">jwst.pipeline</span> <span class="kn">import</span> <span class="n">Detector1Pipeline</span><span class="p">,</span> <span class="n">Image2Pipeline</span><span class="p">,</span> <span class="n">Image3Pipeline</span>
<span class="kn">from</span> <span class="nn">jwst</span> <span class="kn">import</span> <span class="n">associations</span>
<span class="kn">from</span> <span class="nn">jwst.associations.lib.rules_level3_base</span> <span class="kn">import</span> <span class="n">DMS_Level3_Base</span>
<span class="kn">from</span> <span class="nn">jwst.associations</span> <span class="kn">import</span> <span class="n">asn_from_list</span>

<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">photutils</span> <span class="kn">import</span> <span class="n">CircularAperture</span><span class="p">,</span> <span class="n">DAOStarFinder</span><span class="p">,</span> <span class="n">CircularAnnulus</span><span class="p">,</span> <span class="n">aperture_photometry</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="create-a-temporary-directory-to-work-in-and-read-in-data">
<h2>Create a temporary directory to work in and read in data<a class="headerlink" href="#create-a-temporary-directory-to-work-in-and-read-in-data" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a temporary directory to hold notebook output, and change the working directory to that directory.</span>
<span class="kn">from</span> <span class="nn">tempfile</span> <span class="kn">import</span> <span class="n">TemporaryDirectory</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">data_dir</span> <span class="o">=</span> <span class="n">TemporaryDirectory</span><span class="p">()</span>
<span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">data_dir</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">data_dir</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#print(&quot;Downloading input files&quot;)</span>
 
<span class="c1">#This readnoise file is needed for use with simulated data which has higher readnoise than actual data.</span>
<span class="c1">#readnoise = get_bigdata(&#39;jwst_validation_notebooks&#39;,</span>
<span class="c1">#                     &#39;validation_data&#39;,</span>
<span class="c1">#                     &#39;jump&#39;,                     </span>
<span class="c1">#                     &#39;jump_miri_test&#39;, </span>
<span class="c1">#                     &#39;jwst_mirisim_readnoise.fits&#39;)</span>

<span class="c1">#filelist = [&#39;starfield_50star4ptdither_seq1_MIRIMAGE_F1130Wexp1.fits&#39;, </span>
<span class="c1">#            &#39;starfield_50star4ptdither_seq1_MIRIMAGE_F1130Wexp2.fits&#39;,</span>
<span class="c1">#            &#39;starfield_50star4ptdither_seq2_MIRIMAGE_F1130Wexp1.fits&#39;,</span>
<span class="c1">#            &#39;starfield_50star4ptdither_seq2_MIRIMAGE_F1130Wexp2.fits&#39;,</span>
<span class="c1">#            &#39;starfield_50star4ptdither_seq3_MIRIMAGE_F1130Wexp1.fits&#39;,</span>
<span class="c1">#            &#39;starfield_50star4ptdither_seq3_MIRIMAGE_F1130Wexp2.fits&#39;,</span>
<span class="c1">#            &#39;starfield_50star4ptdither_seq4_MIRIMAGE_F1130Wexp1.fits&#39;,</span>
<span class="c1">#            &#39;starfield_50star4ptdither_seq4_MIRIMAGE_F1130Wexp2.fits&#39;]</span>

<span class="c1">#for file in filelist:</span>
<span class="c1">#    input_file = get_bigdata(&#39;jwst_validation_notebooks&#39;,</span>
<span class="c1">#                     &#39;validation_data&#39;,</span>
<span class="c1">#                     &#39;outlier_detection&#39;,</span>
<span class="c1">#                     &#39;outlier_detection_miri_test&#39;,</span>
<span class="c1">#                     file)</span>
    
<span class="c1">#coords = get_bigdata(&#39;jwst_validation_notebooks&#39;,</span>
<span class="c1">#                     &#39;validation_data&#39;,</span>
<span class="c1">#                     &#39;resample&#39;,</span>
<span class="c1">#                     &#39;resample_miri_test&#39;, </span>
<span class="c1">#                     &#39;radec_4ptdith_50star_mosaic_coords.txt&#39;)    </span>

<span class="c1">#print(&quot;Finished Downloads&quot;)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Read rate files in from Box rather than starting with uncal and running through calwebb_detector1</span>

<span class="k">def</span> <span class="nf">get_box_files</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">box_url</span><span class="p">,</span><span class="n">file_name</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="s1">&#39;https&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">box_url</span><span class="p">:</span>
            <span class="n">box_url</span> <span class="o">=</span> <span class="s1">&#39;https://stsci.box.com/shared/static/&#39;</span> <span class="o">+</span> <span class="n">box_url</span>
        <span class="n">downloaded_file</span> <span class="o">=</span> <span class="n">download_file</span><span class="p">(</span><span class="n">box_url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">600</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">Path</span><span class="p">(</span><span class="n">file_name</span><span class="p">)</span><span class="o">.</span><span class="n">suffix</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">ext</span> <span class="o">=</span> <span class="n">splitext</span><span class="p">(</span><span class="n">box_url</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">file_name</span> <span class="o">+=</span> <span class="n">ext</span>
        <span class="n">move</span><span class="p">(</span><span class="n">downloaded_file</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>

        
<span class="n">file_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://stsci.box.com/shared/static/46kwitm6fswmeiuw4gu6xxgeioy7dhca.fits&#39;</span><span class="p">,</span>
             <span class="s1">&#39;https://stsci.box.com/shared/static/8vs4njvio6y15cdcl3rjtb4veb55h6o9.fits&#39;</span><span class="p">,</span>
             <span class="s1">&#39;https://stsci.box.com/shared/static/09xjv0lpe35o50f2xf4ydu523g03s9fd.fits&#39;</span><span class="p">,</span>
             <span class="s1">&#39;https://stsci.box.com/shared/static/tqay5edhq1hstayk897ugd8t5sjbbjme.fits&#39;</span><span class="p">,</span>
             <span class="s1">&#39;https://stsci.box.com/shared/static/rmri5jb6gwpezva2rgzkkguoeos7nocv.fits&#39;</span><span class="p">,</span>
             <span class="s1">&#39;https://stsci.box.com/shared/static/pdtjm55j5ahj08i1rm91jw5p2ijpvi68.fits&#39;</span><span class="p">,</span>
             <span class="s1">&#39;https://stsci.box.com/shared/static/bw5jsrorue4g2eprpd06w8sdvy6etqhv.fits&#39;</span><span class="p">,</span>
             <span class="s1">&#39;https://stsci.box.com/shared/static/y3thiqwcyihw30vndpy16o8bjxn36o89.fits&#39;</span><span class="p">,</span>
             <span class="s1">&#39;https://stsci.box.com/shared/static/u2wc9ocug98ut8arz383oid0eru06qbo.txt&#39;</span><span class="p">]</span>
    
<span class="n">file_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;starfield_50star4ptdither_seq1_MIRIMAGE_F1130Wexp1_rate.fits&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;starfield_50star4ptdither_seq1_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq2_MIRIMAGE_F1130Wexp1_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq2_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq3_MIRIMAGE_F1130Wexp1_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq3_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq4_MIRIMAGE_F1130Wexp1_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq4_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;radec_4ptdith_50star_mosaic_coords.txt&#39;</span><span class="p">]</span>

    
<span class="n">box_download_list</span> <span class="o">=</span> <span class="p">[(</span><span class="n">url</span><span class="p">,</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">url</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">file_urls</span><span class="p">,</span><span class="n">file_names</span><span class="p">)]</span>


<span class="n">get_box_files</span><span class="p">(</span><span class="n">box_download_list</span><span class="p">)</span>
    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">coords</span> <span class="o">=</span> <span class="s1">&#39;radec_4ptdith_50star_mosaic_coords.txt&#39;</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-the-calwebb-detector1-pipeline-to-get-rate-fits-files">
<h2>Run the calwebb_detector1 pipeline to get rate.fits files.<a class="headerlink" href="#run-the-calwebb-detector1-pipeline-to-get-rate-fits-files" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run the calwebb_detector1 pipeline</span>

<span class="c1"># set up pipeline parameters </span>
<span class="c1">#rej_thresh=10.0  # rejection threshold for jump step</span>

<span class="c1">#print(&#39;There are &#39;, len(filelist), &#39; images.&#39;)</span>
    
<span class="c1">#slopelist = []    </span>
    
<span class="c1"># loop over list of files</span>
<span class="c1">#for file in filelist:</span>
       
    <span class="c1"># set up pipeline parameters for input</span>
<span class="c1">#    pipe1 = Detector1Pipeline()</span>
<span class="c1">#    pipe1.jump.rejection_threshold = rej_thresh</span>
<span class="c1">#    pipe1.jump.override_readnoise = readnoise</span>
<span class="c1">#    pipe1.ramp_fit.override_readnoise = readnoise</span>

<span class="c1">#    pipe1.refpix.skip = True  # needs update to simulator for this to work properly with simulated data</span>
        
    <span class="c1"># set up output file name</span>
<span class="c1">#    base, remainder = file.split(&#39;.&#39;)</span>
<span class="c1">#    outname = base</span>
        
<span class="c1">#    pipe1.jump.output_file = outname+&#39;.fits&#39;    </span>
    <span class="c1">#pipe1.ramp_fit.output_file = outname+&#39;.fits&#39;</span>
<span class="c1">#    pipe1.output_file = outname+&#39;.fits&#39;</span>

    <span class="c1"># Run pipeline on each file</span>
<span class="c1">#    rampfile = pipe1.run(file)</span>
<span class="c1">#    slopelist.append(rampfile)</span>
    
    <span class="c1"># Close the input files</span>
    <span class="c1">#file.close()</span>

<span class="c1">#print(&#39;Detector 1 steps completed on all files.&#39;)</span>
<span class="c1">#print(slopelist)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">slopelist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;starfield_50star4ptdither_seq1_MIRIMAGE_F1130Wexp1_rate.fits&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;starfield_50star4ptdither_seq1_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq2_MIRIMAGE_F1130Wexp1_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq2_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq3_MIRIMAGE_F1130Wexp1_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq3_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq4_MIRIMAGE_F1130Wexp1_rate.fits&#39;</span><span class="p">,</span>
            <span class="s1">&#39;starfield_50star4ptdither_seq4_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-calwebb-image2-pipeline-to-create-cal-fits-files">
<h2>Run calwebb_image2 pipeline to create cal.fits files<a class="headerlink" href="#run-calwebb-image2-pipeline-to-create-cal-fits-files" title="Permalink to this headline">#</a></h2>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Calwebb_image2 on output files from detector1</span>
    
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;There are &#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">slopelist</span><span class="p">),</span> <span class="s1">&#39; images.&#39;</span><span class="p">)</span>

<span class="n">callist</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ratefilenames</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># cycle through files</span>
<span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">slopelist</span><span class="p">:</span>
    <span class="n">rampfile</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
    
    <span class="c1"># create an object for the pipeline    </span>
    <span class="n">pipe2</span> <span class="o">=</span> <span class="n">Image2Pipeline</span><span class="p">()</span>
    
    <span class="n">filename</span> <span class="o">=</span> <span class="n">rampfile</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">filename</span>
    <span class="n">ratefilenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="c1"># Set pipeline parameters</span>

    <span class="n">pipe2</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pipe2</span><span class="o">.</span><span class="n">output_file</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span><span class="s1">&#39;_cal.fits&#39;</span>
    <span class="n">pipe2</span><span class="o">.</span><span class="n">resample</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pipe2</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">calfile</span> <span class="o">=</span> <span class="n">pipe2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">rampfile</span><span class="p">)</span>

    <span class="n">callist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">calfile</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="n">callist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">imagelist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ele</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;rate&#39;</span><span class="p">,</span> <span class="s1">&#39;cal&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">ratefilenames</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">imagelist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-1-see-what-happens-with-tweakreg-when-given-data-with-no-shifts">
<h2>Test # 1: See what happens with tweakreg when given data with no shifts.<a class="headerlink" href="#test-1-see-what-happens-with-tweakreg-when-given-data-with-no-shifts" title="Permalink to this headline">#</a></h2>
<p>This test uses MIRISim data using only the simulated dithers, and no shifts. Two exposures each of four different dithers, perfect alignment.</p>
<p>First look at the cal images out of calwebb_image2.</p>
<ul class="simple">
<li><p>Use DAOStarFinder to get the x,y positions of the stars in each image</p></li>
<li><p>Use wcs info from image to convert x,y positions to RA, Dec</p></li>
<li><p>Compare the RA, Dec calculated values to the RA, Dec positions put into the simulated images</p></li>
<li><p>Get statistics on the differences of the calculated and input positions in units of mas</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find stars and get RA, Dec from *_cal.fits files</span>

<span class="c1"># Run DAOStarFinder to find sources in image</span>
<span class="n">allRAdiff_cal</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">allDecdiff_cal</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">calimage</span> <span class="ow">in</span> <span class="n">imagelist</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">calimage</span><span class="p">)</span>
    
    <span class="c1"># pull out data portion of input file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span>
    
    <span class="c1"># print stats on input image</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">calimage</span><span class="p">)</span>
    <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image mean, median and std&#39;</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>

    <span class="n">ap_radius</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># radius for aperture for centroiding and photometry</span>

    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>    <span class="c1"># default threshold=5*std, fwhm=3</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>     

    <span class="c1"># Create apertures for x,y positions</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
    <span class="c1">#print(positions)</span>

    <span class="c1">#positions = (sources[&#39;xcentroid&#39;], sources[&#39;ycentroid&#39;])</span>
    <span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">)</span>
    
    <span class="c1"># using wcs info from images, put coordinates into RA, Dec</span>
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

    <span class="c1"># add RA, Dec to sources table</span>

    <span class="n">ra_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ra</span><span class="p">)</span>
    <span class="n">dec_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
    <span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">ra_col</span><span class="p">)</span>
    <span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">dec_col</span><span class="p">)</span>

    <span class="c1"># print RA, Dec for each x, y position found</span>
    <span class="c1">#print(sources[&#39;xcentroid&#39;, &#39;ycentroid&#39;, &#39;RA&#39;, &#39;Dec&#39;])  </span>

    <span class="n">sources_sub</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
    <span class="n">sources_sub</span><span class="o">.</span><span class="n">pprint_all</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># read in text file with RA and Dec input coordinates</span>
    <span class="n">RA_in</span><span class="p">,</span> <span class="n">Dec_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span> <span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># put RA and Dec into floats</span>
    <span class="n">RA_sim</span> <span class="o">=</span> <span class="n">RA_in</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">Dec_sim</span> <span class="o">=</span> <span class="n">Dec_in</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="c1"># Put ra, dec coords into a table</span>
    <span class="n">cat1_sim</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">RA_sim</span><span class="p">,</span> <span class="n">Dec_sim</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    <span class="n">cat2_calc</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    
    <span class="c1"># Get coordinates with SkyCoord for each catalog</span>
    
    <span class="n">coord_cat1_sim</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
    <span class="n">coord_cat2_calc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
    <span class="n">ind_cat2_cat1</span><span class="p">,</span> <span class="n">dist_2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">coord_cat1_sim</span><span class="p">,</span> <span class="n">coord_cat2_calc</span><span class="p">)</span>
    
    <span class="c1"># Find where the catalogs match</span>
    
    <span class="n">cat1_matched</span> <span class="o">=</span> <span class="n">cat1_sim</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]</span>
    <span class="n">cat2_matched</span> <span class="o">=</span> <span class="n">cat2_calc</span><span class="p">[</span><span class="n">ind_cat2_cat1</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]]</span>
    
    <span class="c1">#print(cat1_matched)</span>
    
    <span class="c1"># Get differences in RA, Dec</span>
    <span class="n">ra_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
    <span class="n">dec_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> 
    
    <span class="c1">#print(ra_diff)</span>
    
    <span class="c1"># put differences in milliarcseconds</span>
    <span class="n">ra_diff</span> <span class="o">=</span> <span class="n">ra_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
    <span class="n">dec_diff</span> <span class="o">=</span> <span class="n">dec_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
    
    
    <span class="c1"># Compare input RA, Dec to found RA, Dec</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;</span><span class="p">)</span>
    <span class="c1"># Find if the differences are within the allowed 30 mas range</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">)):</span>
        <span class="c1">#if ra_diff[i] &lt; 30 and dec_diff[i] &lt; 30:</span>
        <span class="n">allRAdiff_cal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">allDecdiff_cal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span> 
            <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;pass&#39;</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">))</span>
 
    
    <span class="c1"># Plot ra and dec differences</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s1">&#39;Differences in RA and Dec in milliarcseconds&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Delta RA&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Delta Dec&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">,</span><span class="n">dec_diff</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
 
    <span class="c1"># Plot should show no differences greater than 30 milliarcseconds  </span>
    
<span class="n">meanRAdiff_cal</span><span class="p">,</span> <span class="n">medianRAdiff_cal</span><span class="p">,</span> <span class="n">stdRAdiff_cal</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">allRAdiff_cal</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="n">meanDecdiff_cal</span><span class="p">,</span> <span class="n">medianDecdiff_cal</span><span class="p">,</span> <span class="n">stdDecdiff_cal</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">allDecdiff_cal</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanRAdiff_cal</span><span class="p">,</span> <span class="n">medianRAdiff_cal</span><span class="p">,</span> <span class="n">stdRAdiff_cal</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanDecdiff_cal</span><span class="p">,</span> <span class="n">medianDecdiff_cal</span><span class="p">,</span> <span class="n">stdDecdiff_cal</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="run-the-images-through-calwebb-image3-with-tweakreg-on">
<h3>Run the images through calwebb_image3 with tweakreg on<a class="headerlink" href="#run-the-images-through-calwebb-image3-with-tweakreg-on" title="Permalink to this headline">#</a></h3>
<p>Alter any parameters needed to get better results from tweakreg. Look at individual i2d images afterwards.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># use asn_from_list to create association table</span>

<span class="c1">#calfiles = glob.glob(&#39;starfield*_cal.fits&#39;)</span>
<span class="n">asn</span> <span class="o">=</span> <span class="n">asn_from_list</span><span class="o">.</span><span class="n">asn_from_list</span><span class="p">(</span><span class="n">imagelist</span><span class="p">,</span> <span class="n">rule</span><span class="o">=</span><span class="n">DMS_Level3_Base</span><span class="p">,</span> <span class="n">product_name</span><span class="o">=</span><span class="s1">&#39;starfield_50star4ptdither_combined.fits&#39;</span><span class="p">)</span>

<span class="c1"># use this if you need to add non&#39;science&#39; exposure types</span>
<span class="c1">#asn[&#39;products&#39;][0][&#39;members&#39;][1][&#39;exptype&#39;] = &#39;background&#39;</span>
<span class="c1">#asn[&#39;products&#39;][0][&#39;members&#39;][2][&#39;exptype&#39;] = &#39;sourcecat&#39;</span>

<span class="c1"># dump association table to a .json file for use in image3</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_asnfile.json&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">asn</span><span class="o">.</span><span class="n">dump</span><span class="p">()[</span><span class="mi">1</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">asn</span><span class="p">)</span>    
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Calwebb_image3 on the association table with tweakreg on</span>
    
<span class="c1"># set any specific parameters</span>
<span class="c1"># tweakreg parameters to allow data to run</span>
<span class="n">fwhm</span> <span class="o">=</span> <span class="mf">3.318</span> <span class="c1">#3.27  # Gaussian kernel FWHM of objects expected, default=2.5</span>
<span class="n">minobj</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># minimum number of objects needed to match positions for a good fit, default=15</span>
<span class="n">snr</span> <span class="o">=</span> <span class="mi">40</span> <span class="c1"># signal to noise threshold, default=5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># clipping limit, in sigma units, used when performing fit, default=3</span>
<span class="n">fit_geom</span> <span class="o">=</span><span class="s1">&#39;rshift&#39;</span> <span class="c1"># ftype of affine transformation to be considered when fitting catalogs, default=&#39;general&#39;</span>
<span class="n">use2dhist</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># boolean indicating whether to use 2D histogram to find initial offset, default=True</span>
   
<span class="n">pipe3</span><span class="o">=</span><span class="n">Image3Pipeline</span><span class="p">()</span>    
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">kernel_fwhm</span> <span class="o">=</span> <span class="n">fwhm</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">snr_threshold</span> <span class="o">=</span> <span class="n">snr</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">minobj</span> <span class="o">=</span> <span class="n">minobj</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">fitgeometry</span> <span class="o">=</span> <span class="n">fit_geom</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">use2dhist</span> <span class="o">=</span> <span class="n">use2dhist</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">save_catalogs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#pipe3.tweakreg.skip = True        # test to see if this affects the final output</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">outlier_detection</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># this is set in later step so mis-alignments aren&#39;t &#39;hidden&#39;</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">outlier_detection</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">source_catalog</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#pipe3.output_dir = datadir</span>

<span class="c1"># run Image3</span>

<span class="c1">#im = pipe3.run(rtdata.input)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">pipe3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_asnfile.json&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image 3 pipeline finished.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="go-through-list-of-individual-images-and-see-which-sources-were-found-for-each-image">
<h3>Go through list of individual images and see which sources were found for each image.<a class="headerlink" href="#go-through-list-of-individual-images-and-see-which-sources-were-found-for-each-image" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get list of catalogs</span>

<span class="n">cataloglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ele</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cal.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;cal_cat.ecsv&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">imagelist</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">imagelist</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cataloglist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loop through each image and overplot the sources found in the individual catalogs</span>

<span class="n">index</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">cal_image</span> <span class="ow">in</span> <span class="n">imagelist</span><span class="p">:</span>
    <span class="n">indimage</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">cal_image</span><span class="p">)</span>
    <span class="n">ind_data</span> <span class="o">=</span> <span class="n">indimage</span><span class="o">.</span><span class="n">data</span>
    
    <span class="n">indcat</span> <span class="o">=</span> <span class="n">cataloglist</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">catdata</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">indcat</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cal_image</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">indcat</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">catdata</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]),</span> <span class="s1">&#39;sources found&#39;</span><span class="p">)</span>
    
    <span class="c1"># mark sources on image frame to see if the correct sources were found</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
    <span class="c1"># keep image stretch in mind for plotting. sky subtracted range ~ (-15, 10), single sample ~ (0, 20)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ind_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="c1">#, norm=norm)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">catdata</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">catdata</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="get-position-differences-as-found-earlier-for-the-individual-i2d-files">
<h3>Get position differences as found earlier for the individual i2d files<a class="headerlink" href="#get-position-differences-as-found-earlier-for-the-individual-i2d-files" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find stars and get RA, Dec from *_i2d.fits files</span>

<span class="c1">#datadir = &#39;/ifs/jwst/wit/miri/pipelinetests/cracraft/build7_8/&#39;</span>
<span class="c1">#filelist = &#39;starfield_50star4ptdither_i2dfiles.txt&#39;</span>
<span class="n">filelist</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;*exp*i2d.fits&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">filelist</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Run DAOStarFinder to find sources in image</span>
<span class="n">allRAdiff_i2d</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">allDecdiff_i2d</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i2dimage</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">i2dimage</span><span class="p">)</span>
    
    <span class="c1"># pull out data portion of input file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span>
    
    <span class="c1"># print stats on input image</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i2dimage</span><span class="p">)</span>
    <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image mean, median and std&#39;</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>

    <span class="n">ap_radius</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># radius for aperture for centroiding and photometry</span>

    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>    <span class="c1"># default threshold=5*std, fwhm=3</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>    

    <span class="c1">#sources.pprint_all()</span>
    <span class="c1">#print(sources[&#39;xcentroid&#39;,&#39;ycentroid&#39;,&#39;peak&#39;])   </span>

    <span class="c1"># Create apertures for x,y positions</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
    <span class="c1">#print(positions)</span>

    <span class="c1">#positions = (sources[&#39;xcentroid&#39;], sources[&#39;ycentroid&#39;])</span>
    <span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">)</span>
    
    <span class="c1"># using wcs info from images, put coordinates into RA, Dec</span>
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

    <span class="c1"># add RA, Dec to sources table</span>

    <span class="n">ra_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ra</span><span class="p">)</span>
    <span class="n">dec_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
    <span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">ra_col</span><span class="p">)</span>
    <span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">dec_col</span><span class="p">)</span>

    <span class="c1"># print RA, Dec for each x, y position found</span>
    <span class="c1">#print(sources[&#39;xcentroid&#39;, &#39;ycentroid&#39;, &#39;RA&#39;, &#39;Dec&#39;])  </span>

    <span class="n">sources_sub</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
    <span class="n">sources_sub</span><span class="o">.</span><span class="n">pprint_all</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># read in text file with RA and Dec input coordinates</span>
    <span class="n">RA_in</span><span class="p">,</span> <span class="n">Dec_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span> <span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># put RA and Dec into floats</span>
    <span class="n">RA_sim</span> <span class="o">=</span> <span class="n">RA_in</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">Dec_sim</span> <span class="o">=</span> <span class="n">Dec_in</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="c1"># Put ra, dec coords into a table</span>
    <span class="n">cat1_sim</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">RA_sim</span><span class="p">,</span> <span class="n">Dec_sim</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    <span class="n">cat2_calc</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    
    <span class="c1"># Get coordinates with SkyCoord for each catalog</span>
    
    <span class="n">coord_cat1_sim</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
    <span class="n">coord_cat2_calc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
    <span class="n">ind_cat2_cat1</span><span class="p">,</span> <span class="n">dist_2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">coord_cat1_sim</span><span class="p">,</span> <span class="n">coord_cat2_calc</span><span class="p">)</span>
    
    <span class="c1"># Find where the catalogs match</span>
    
    <span class="n">cat1_matched</span> <span class="o">=</span> <span class="n">cat1_sim</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]</span>
    <span class="n">cat2_matched</span> <span class="o">=</span> <span class="n">cat2_calc</span><span class="p">[</span><span class="n">ind_cat2_cat1</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]]</span>
    
    <span class="c1">#print(cat1_matched)</span>
    
    <span class="c1"># Get differences in RA, Dec</span>
    <span class="n">ra_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
    <span class="n">dec_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> 
    
    <span class="c1">#print(ra_diff)</span>
    
    <span class="c1"># put differences in milliarcseconds</span>
    <span class="n">ra_diff</span> <span class="o">=</span> <span class="n">ra_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
    <span class="n">dec_diff</span> <span class="o">=</span> <span class="n">dec_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
    
    
    <span class="c1"># Compare input RA, Dec to found RA, Dec</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;</span><span class="p">)</span>
    <span class="c1"># Find if the differences are within the allowed 30 mas range</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">)):</span>
        <span class="c1">#if ra_diff[i] &lt; 30 and dec_diff[i] &lt; 30:</span>
        <span class="n">allRAdiff_i2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">allDecdiff_i2d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span> 
            <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;pass&#39;</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">))</span>
 
    
    <span class="c1"># Plot ra and dec differences</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s1">&#39;Differences in RA and Dec in milliarcseconds&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Delta RA&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Delta Dec&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">,</span><span class="n">dec_diff</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Plot should show no differences greater than 30 milliarcseconds  </span>

    
<span class="n">meanRAdiff_i2d</span><span class="p">,</span> <span class="n">medianRAdiff_i2d</span><span class="p">,</span> <span class="n">stdRAdiff_i2d</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">allRAdiff_i2d</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="n">meanDecdiff_i2d</span><span class="p">,</span> <span class="n">medianDecdiff_i2d</span><span class="p">,</span> <span class="n">stdDecdiff_i2d</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">allDecdiff_i2d</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanRAdiff_i2d</span><span class="p">,</span> <span class="n">medianRAdiff_i2d</span><span class="p">,</span> <span class="n">stdRAdiff_i2d</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanDecdiff_i2d</span><span class="p">,</span> <span class="n">medianDecdiff_i2d</span><span class="p">,</span> <span class="n">stdDecdiff_i2d</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="look-at-positions-of-ra-dec-and-get-stats-on-differences-for-the-combined-image-run-with-tweakreg-on">
<h3>Look at positions of RA, Dec and get stats on differences for the combined image run with tweakreg on<a class="headerlink" href="#look-at-positions-of-ra-dec-and-get-stats-on-differences-for-the-combined-image-run-with-tweakreg-on" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">im</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_combined_i2d.fits&#39;</span><span class="p">)</span>
<span class="n">pixarea</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">pixelarea_steradians</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pixel area in steradians&#39;</span><span class="p">,</span> <span class="n">pixarea</span><span class="p">)</span>

<span class="c1"># pull out data portion of input file</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># print stats on input image</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image mean, median and std&#39;</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run DAOStarFinder to find sources in image</span>

<span class="n">ap_radius</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># radius for aperture for centroiding and photometry</span>

<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>    <span class="c1"># default threshold=5*std, fwhm=3</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>    

<span class="c1"># Create apertures for x,y positions</span>
<span class="n">positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="c1">#print(positions)</span>

<span class="c1">#positions = (sources[&#39;xcentroid&#39;], sources[&#39;ycentroid&#39;])</span>
<span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">)</span>

<span class="c1"># using wcs info from images, put coordinates into RA, Dec</span>
<span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

<span class="c1"># add RA, Dec to sources table</span>

<span class="n">ra_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ra</span><span class="p">)</span>
<span class="n">dec_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">ra_col</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">dec_col</span><span class="p">)</span>

<span class="c1"># print RA, Dec for each x, y position found</span>
<span class="c1">#print(sources[&#39;xcentroid&#39;, &#39;ycentroid&#39;, &#39;RA&#39;, &#39;Dec&#39;])  </span>

<span class="n">sources_sub</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
<span class="n">sources_sub</span><span class="o">.</span><span class="n">pprint_all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Compare input RA, Dec to found RA, Dec</span>
<span class="c1">#print(&#39;       RA found       Dec found    RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;)</span>

<span class="n">deltara_twon</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">deltadec_twon</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Put ra, dec coords into a table</span>
<span class="n">cat1_sim</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">RA_sim</span><span class="p">,</span> <span class="n">Dec_sim</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
<span class="n">cat2_calc</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    
<span class="c1"># Get coordinates with SkyCoord for each catalog</span>
    
<span class="n">coord_cat1_sim</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
<span class="n">coord_cat2_calc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>    
<span class="n">ind_cat2_cat1</span><span class="p">,</span> <span class="n">dist_2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">coord_cat1_sim</span><span class="p">,</span> <span class="n">coord_cat2_calc</span><span class="p">)</span>
    
<span class="c1"># Find where the catalogs match</span>
    
<span class="n">cat1_matched</span> <span class="o">=</span> <span class="n">cat1_sim</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]</span>
<span class="n">cat2_matched</span> <span class="o">=</span> <span class="n">cat2_calc</span><span class="p">[</span><span class="n">ind_cat2_cat1</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]]</span>
    
<span class="c1">#print(cat1_matched)</span>
    
<span class="c1"># Get differences in RA, Dec</span>
<span class="n">ra_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
<span class="n">dec_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> 
    
<span class="c1">#print(ra_diff)</span>
    
<span class="c1"># put differences in milliarcseconds</span>
<span class="n">ra_diff</span> <span class="o">=</span> <span class="n">ra_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
<span class="n">dec_diff</span> <span class="o">=</span> <span class="n">dec_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
    
    
<span class="c1"># Compare input RA, Dec to found RA, Dec</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;</span><span class="p">)</span>
<span class="c1"># Find if the differences are within the allowed 30 mas range</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">)):</span>
    <span class="c1">#if ra_diff[i] &lt; 30 and dec_diff[i] &lt; 30:</span>
    <span class="n">deltara_twon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">deltadec_twon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span> 
        <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;pass&#39;</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">))</span>
 
    
<span class="c1"># Plot ra and dec differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s1">&#39;Differences in RA and Dec in milliarcseconds&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Delta RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Delta Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">deltara_twon</span><span class="p">,</span><span class="n">deltadec_twon</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot should show no differences greater than 30 milliarcseconds  </span>
     
<span class="n">meanRAdiff_twon</span><span class="p">,</span> <span class="n">medianRAdiff_twon</span><span class="p">,</span> <span class="n">stdRAdiff_twon</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">deltara_twon</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="n">meanDecdiff_twon</span><span class="p">,</span> <span class="n">medianDecdiff_twon</span><span class="p">,</span> <span class="n">stdDecdiff_twon</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">deltadec_twon</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanRAdiff_twon</span><span class="p">,</span> <span class="n">medianRAdiff_twon</span><span class="p">,</span> <span class="n">stdRAdiff_twon</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanDecdiff_twon</span><span class="p">,</span> <span class="n">medianDecdiff_twon</span><span class="p">,</span> <span class="n">stdDecdiff_twon</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mark sources on image frame to see if the correct sources were found</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
<span class="c1"># keep image stretch in mind for plotting. sky subtracted range ~ (-15, 10), single sample ~ (0, 20)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="c1">#, norm=norm)</span>
<span class="n">apertures</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="c1">#, alpha=0.5)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="run-calwebb-image3-with-tweakreg-turned-off">
<h3>Run calwebb_image3 with tweakreg turned off<a class="headerlink" href="#run-calwebb-image3-with-tweakreg-turned-off" title="Permalink to this headline">#</a></h3>
<p>Re-run the pipeline with tweakreg turned off to see if the differences found in the previous step are due to tweakreg alone, or differences in the distortion model that would show up in any run of the calwebb_image3 pipeline.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Calwebb_image3 on the association table with tweakreg off</span>
    
<span class="c1"># set any specific parameters</span>
<span class="c1"># tweakreg parameters to allow data to run</span>
<span class="n">fwhm</span> <span class="o">=</span> <span class="mf">3.318</span> <span class="c1">#3.27  # Gaussian kernel FWHM of objects expected, default=2.5</span>
<span class="n">minobj</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># minimum number of objects needed to match positions for a good fit, default=15</span>
<span class="n">snr</span> <span class="o">=</span> <span class="mi">10</span> <span class="c1"># signal to noise threshold, default=5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># clipping limit, in sigma units, used when performing fit, default=3</span>
<span class="n">fit_geom</span> <span class="o">=</span><span class="s1">&#39;rshift&#39;</span> <span class="c1"># ftype of affine transformation to be considered when fitting catalogs, default=&#39;general&#39;</span>
<span class="n">use2dhist</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># boolean indicating whether to use 2D histogram to find initial offset, default=True</span>
   
<span class="n">pipe3</span><span class="o">=</span><span class="n">Image3Pipeline</span><span class="p">()</span>    
<span class="c1">#pipe3.tweakreg.kernel_fwhm = fwhm</span>
<span class="c1">#pipe3.tweakreg.snr_threshold = snr</span>
<span class="c1">#pipe3.tweakreg.minobj = minobj</span>
<span class="c1">#pipe3.tweakreg.sigma = sigma</span>
<span class="c1">#pipe3.tweakreg.fitgeometry = fit_geom</span>
<span class="c1">#pipe3.tweakreg.use2dhist = use2dhist</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>        <span class="c1"># test to see if this affects the final output</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">outlier_detection</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span> <span class="c1"># this is set in later step so mis-alignments aren&#39;t &#39;hidden&#39;</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">source_catalog</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#pipe3.output_dir = datadir</span>

<span class="c1"># run Image3</span>

<span class="c1">#im = pipe3.run(rtdata.input)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">pipe3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_asnfile.json&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image 3 pipeline finished.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">im</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_combined_i2d.fits&#39;</span><span class="p">)</span>
<span class="n">pixarea</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">pixelarea_steradians</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pixel area in steradians&#39;</span><span class="p">,</span> <span class="n">pixarea</span><span class="p">)</span>

<span class="c1"># pull out data portion of input file</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># print stats on input image</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image mean, median and std&#39;</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run DAOStarFinder to find sources in image</span>

<span class="n">ap_radius</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># radius for aperture for centroiding and photometry</span>

<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>    <span class="c1"># default threshold=5*std, fwhm=3</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>    

<span class="c1">#sources.pprint_all()</span>
<span class="c1">#print(sources[&#39;xcentroid&#39;,&#39;ycentroid&#39;,&#39;peak&#39;])   </span>

<span class="c1"># Create apertures for x,y positions</span>
<span class="n">positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="c1">#print(positions)</span>

<span class="c1">#positions = (sources[&#39;xcentroid&#39;], sources[&#39;ycentroid&#39;])</span>
<span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">)</span>


<span class="c1"># using wcs info from images, put coordinates into RA, Dec</span>
<span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

<span class="c1"># add RA, Dec to sources table</span>

<span class="n">ra_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ra</span><span class="p">)</span>
<span class="n">dec_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">ra_col</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">dec_col</span><span class="p">)</span>

<span class="c1"># print RA, Dec for each x, y position found</span>
<span class="c1">#print(sources[&#39;xcentroid&#39;, &#39;ycentroid&#39;, &#39;RA&#39;, &#39;Dec&#39;])  </span>

<span class="n">sources_sub</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
<span class="n">sources_sub</span><span class="o">.</span><span class="n">pprint_all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Compare input RA, Dec to found RA, Dec</span>
<span class="c1">#print(&#39;       RA found       Dec found    RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;)</span>

<span class="n">deltara_twoff</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">deltadec_twoff</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Put ra, dec coords into a table</span>
<span class="n">cat1_sim</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">RA_sim</span><span class="p">,</span> <span class="n">Dec_sim</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
<span class="n">cat2_calc</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    
<span class="c1"># Get coordinates with SkyCoord for each catalog</span>
    
<span class="n">coord_cat1_sim</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
<span class="n">coord_cat2_calc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>    
<span class="n">ind_cat2_cat1</span><span class="p">,</span> <span class="n">dist_2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">coord_cat1_sim</span><span class="p">,</span> <span class="n">coord_cat2_calc</span><span class="p">)</span>
    
<span class="c1"># Find where the catalogs match</span>
    
<span class="n">cat1_matched</span> <span class="o">=</span> <span class="n">cat1_sim</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]</span>
<span class="n">cat2_matched</span> <span class="o">=</span> <span class="n">cat2_calc</span><span class="p">[</span><span class="n">ind_cat2_cat1</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]]</span>
    
<span class="c1">#print(cat1_matched)</span>
    
<span class="c1"># Get differences in RA, Dec</span>
<span class="n">ra_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
<span class="n">dec_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> 
    
<span class="c1">#print(ra_diff)</span>
    
<span class="c1"># put differences in milliarcseconds</span>
<span class="n">ra_diff</span> <span class="o">=</span> <span class="n">ra_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
<span class="n">dec_diff</span> <span class="o">=</span> <span class="n">dec_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
    
    
<span class="c1"># Compare input RA, Dec to found RA, Dec</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;</span><span class="p">)</span>
<span class="c1"># Find if the differences are within the allowed 30 mas range</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">)):</span>
    <span class="c1">#if ra_diff[i] &lt; 30 and dec_diff[i] &lt; 30:</span>
    <span class="n">deltara_twoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">deltadec_twoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span> 
        <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;pass&#39;</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">))</span>
 
    
<span class="c1"># Plot ra and dec differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s1">&#39;Differences in RA and Dec in milliarcseconds&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Delta RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Delta Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">deltara_twoff</span><span class="p">,</span><span class="n">deltadec_twoff</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot should show no differences greater than 30 milliarcseconds      </span>
    
<span class="n">meanRAdiff_twoff</span><span class="p">,</span> <span class="n">medianRAdiff_twoff</span><span class="p">,</span> <span class="n">stdRAdiff_twoff</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">deltara_twoff</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="n">meanDecdiff_twoff</span><span class="p">,</span> <span class="n">medianDecdiff_twoff</span><span class="p">,</span> <span class="n">stdDecdiff_twoff</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">deltadec_twoff</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanRAdiff_twoff</span><span class="p">,</span> <span class="n">medianRAdiff_twoff</span><span class="p">,</span> <span class="n">stdRAdiff_twoff</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanDecdiff_twoff</span><span class="p">,</span> <span class="n">medianDecdiff_twoff</span><span class="p">,</span> <span class="n">stdDecdiff_twoff</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mark sources on image frame to see if the correct sources were found</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
<span class="c1"># keep image stretch in mind for plotting. sky subtracted range ~ (-15, 10), single sample ~ (0, 20)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="c1">#, norm=norm)</span>
<span class="n">apertures</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="c1">#, alpha=0.5)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare stats across tests:</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All units are milliarcseconds for statistics&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Statistics on differences between RA and Dec in individual calibrated files&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanRAdiff_cal</span><span class="p">,</span> <span class="n">medianRAdiff_cal</span><span class="p">,</span> <span class="n">stdRAdiff_cal</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanDecdiff_cal</span><span class="p">,</span> <span class="n">medianDecdiff_cal</span><span class="p">,</span> <span class="n">stdDecdiff_cal</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Statistics on differences between RA and Dec in individual i2d files when run with tweakreg on&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanRAdiff_i2d</span><span class="p">,</span> <span class="n">medianRAdiff_i2d</span><span class="p">,</span> <span class="n">stdRAdiff_i2d</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanDecdiff_i2d</span><span class="p">,</span> <span class="n">medianDecdiff_i2d</span><span class="p">,</span> <span class="n">stdDecdiff_i2d</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Statistics on differences between RA and Dec in combined i2d file when run with tweakreg on&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanRAdiff_twon</span><span class="p">,</span> <span class="n">medianRAdiff_twon</span><span class="p">,</span> <span class="n">stdRAdiff_twon</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanDecdiff_twon</span><span class="p">,</span> <span class="n">medianDecdiff_twon</span><span class="p">,</span> <span class="n">stdDecdiff_twon</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Statistics on differences between RA and Dec in combined i2d file when run with tweakreg off&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanRAdiff_twoff</span><span class="p">,</span> <span class="n">medianRAdiff_twoff</span><span class="p">,</span> <span class="n">stdRAdiff_twoff</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanDecdiff_twoff</span><span class="p">,</span> <span class="n">medianDecdiff_twoff</span><span class="p">,</span> <span class="n">stdDecdiff_twoff</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
</section>
<section id="test-2-see-what-happens-with-tweakreg-when-there-are-shifts-between-images-not-tracked-in-the-wcs">
<h2>Test # 2: See what happens with tweakreg when there are shifts between images not tracked in the wcs.<a class="headerlink" href="#test-2-see-what-happens-with-tweakreg-when-there-are-shifts-between-images-not-tracked-in-the-wcs" title="Permalink to this headline">#</a></h2>
<p>This test uses MIRISim data using only the simulated dithers, and one shifted image. Two exposures each of four different dithers.</p>
<p>First look at the cal images out of calwebb_image2.</p>
<ul class="simple">
<li><p>Apply specified shift (~0.5 arcseconds) to x and y positions of one image</p></li>
<li><p>Use DAOStarFinder to get the x,y positions of the stars in each image</p></li>
<li><p>Use wcs info from image to convert x,y positions to RA, Dec</p></li>
<li><p>Compare the RA, Dec calculated values to the RA, Dec positions put into the simulated images</p></li>
<li><p>Get statistics on the differences of the calculated and input positions in units of mas</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># apply shifts to files in input list</span>

<span class="c1"># Read in a single rate.fits file, modify header values RA_REF and DEC_REF by adding in a shift of less than one </span>
<span class="c1"># arcsecond, which is the default search radius for tweakreg</span>
<span class="c1"># 0.72 arcseconds ~ 0.0002 degrees</span>
<span class="c1"># 0.5 arcseconds ~ 0.00014 degrees</span>

<span class="n">origfile</span> <span class="o">=</span> <span class="s1">&#39;starfield_50star4ptdither_seq2_MIRIMAGE_F1130Wexp2_rate.fits&#39;</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">origfile</span><span class="p">)</span>

<span class="c1"># modify header vaules</span>

<span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">ra_ref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">ra_ref</span> <span class="o">+</span> <span class="mf">0.00014</span>
<span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">dec_ref</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcsinfo</span><span class="o">.</span><span class="n">dec_ref</span> <span class="o">+</span> <span class="mf">0.00014</span>

<span class="c1"># Run file through calwebb_image2 to get cal.fits version and then retest steps in Test # 1.</span>

<span class="c1"># create an object for the pipeline    </span>
<span class="n">pipe2</span> <span class="o">=</span> <span class="n">Image2Pipeline</span><span class="p">()</span>
<span class="n">pipe2</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#pipe2.output_file = rampfile+&#39;_cal.fits&#39;</span>
<span class="c1">#pipe2.output_dir = datadir</span>
<span class="n">pipe2</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">model</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># find stars and get RA, Dec from *_cal.fits files</span>

<span class="c1"># Run DAOStarFinder to find sources in image</span>
<span class="n">allRAdiff_cal</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">allDecdiff_cal</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">calimage</span> <span class="ow">in</span> <span class="n">imagelist</span><span class="p">:</span>
    <span class="n">image</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">calimage</span><span class="p">)</span>
    
    <span class="c1"># pull out data portion of input file</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">data</span>
    
    <span class="c1"># print stats on input image</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">calimage</span><span class="p">)</span>
    <span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image mean, median and std&#39;</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>

    <span class="n">ap_radius</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># radius for aperture for centroiding and photometry</span>

    <span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>    <span class="c1"># default threshold=5*std, fwhm=3</span>
    <span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>      

    <span class="c1"># Create apertures for x,y positions</span>
    <span class="n">positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
    <span class="c1">#print(positions)</span>

    <span class="c1">#positions = (sources[&#39;xcentroid&#39;], sources[&#39;ycentroid&#39;])</span>
    <span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">)</span>
    
    <span class="c1"># using wcs info from images, put coordinates into RA, Dec</span>
    <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

    <span class="c1"># add RA, Dec to sources table</span>

    <span class="n">ra_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ra</span><span class="p">)</span>
    <span class="n">dec_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
    <span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">ra_col</span><span class="p">)</span>
    <span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">dec_col</span><span class="p">)</span>

    <span class="c1"># print RA, Dec for each x, y position found</span>
    <span class="c1">#print(sources[&#39;xcentroid&#39;, &#39;ycentroid&#39;, &#39;RA&#39;, &#39;Dec&#39;])  </span>

    <span class="n">sources_sub</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
    <span class="n">sources_sub</span><span class="o">.</span><span class="n">pprint_all</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">()</span>
    
    <span class="c1"># read in text file with RA and Dec input coordinates</span>
    <span class="n">RA_in</span><span class="p">,</span> <span class="n">Dec_in</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">coords</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span> <span class="n">unpack</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># put RA and Dec into floats</span>
    <span class="n">RA_sim</span> <span class="o">=</span> <span class="n">RA_in</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    <span class="n">Dec_sim</span> <span class="o">=</span> <span class="n">Dec_in</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>
    
    <span class="c1"># Put ra, dec coords into a table</span>
    <span class="n">cat1_sim</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">RA_sim</span><span class="p">,</span> <span class="n">Dec_sim</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    <span class="n">cat2_calc</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    

    <span class="c1"># Get coordinates with SkyCoord for each catalog</span>
    
    <span class="n">coord_cat1_sim</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
    <span class="n">coord_cat2_calc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
    <span class="n">ind_cat2_cat1</span><span class="p">,</span> <span class="n">dist_2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">coord_cat1_sim</span><span class="p">,</span> <span class="n">coord_cat2_calc</span><span class="p">)</span>
    
    <span class="c1"># Find where the catalogs match</span>
    
    <span class="n">cat1_matched</span> <span class="o">=</span> <span class="n">cat1_sim</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]</span>
    <span class="n">cat2_matched</span> <span class="o">=</span> <span class="n">cat2_calc</span><span class="p">[</span><span class="n">ind_cat2_cat1</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]]</span>
    
    <span class="c1">#print(cat1_matched)</span>
    
    <span class="c1"># Get differences in RA, Dec</span>
    <span class="n">ra_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
    <span class="n">dec_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> 
    
    <span class="c1">#print(ra_diff)</span>
    
    <span class="c1"># put differences in milliarcseconds</span>
    <span class="n">ra_diff</span> <span class="o">=</span> <span class="n">ra_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
    <span class="n">dec_diff</span> <span class="o">=</span> <span class="n">dec_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
    
    
    <span class="c1"># Compare input RA, Dec to found RA, Dec</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;</span><span class="p">)</span>
    <span class="c1"># Find if the differences are within the allowed 30 mas range</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">)):</span>
        <span class="c1">#if ra_diff[i] &lt; 30 and dec_diff[i] &lt; 30:</span>
        <span class="n">allRAdiff_cal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">allDecdiff_cal</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span> 
            <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;pass&#39;</span> 
        <span class="k">else</span><span class="p">:</span> 
            <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">))</span>
 
    
    <span class="c1"># Plot ra and dec differences</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s1">&#39;Differences in RA and Dec in milliarcseconds&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Delta RA&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Delta Dec&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">,</span><span class="n">dec_diff</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

    <span class="c1"># Plot should show no differences greater than 30 milliarcseconds  </span>
    
<span class="n">meanRAdiff_cal</span><span class="p">,</span> <span class="n">medianRAdiff_cal</span><span class="p">,</span> <span class="n">stdRAdiff_cal</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">allRAdiff_cal</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="n">meanDecdiff_cal</span><span class="p">,</span> <span class="n">medianDecdiff_cal</span><span class="p">,</span> <span class="n">stdDecdiff_cal</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">allDecdiff_cal</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanRAdiff_cal</span><span class="p">,</span> <span class="n">medianRAdiff_cal</span><span class="p">,</span> <span class="n">stdRAdiff_cal</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanDecdiff_cal</span><span class="p">,</span> <span class="n">medianDecdiff_cal</span><span class="p">,</span> <span class="n">stdDecdiff_cal</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<section id="id1">
<h3>Run the images through calwebb_image3 with tweakreg on<a class="headerlink" href="#id1" title="Permalink to this headline">#</a></h3>
<p>Alter any parameters needed to get better results from tweakreg. Look at individual i2d images afterwards.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Calwebb_image3 on the association table with tweakreg on</span>
    
<span class="c1"># set any specific parameters</span>
<span class="c1"># tweakreg parameters to allow data to run</span>
<span class="n">fwhm</span> <span class="o">=</span> <span class="mf">3.318</span> <span class="c1">#3.27  # Gaussian kernel FWHM of objects expected, default=2.5</span>
<span class="n">minobj</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># minimum number of objects needed to match positions for a good fit, default=15</span>
<span class="n">snr</span> <span class="o">=</span> <span class="mi">40</span> <span class="c1"># signal to noise threshold, default=5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># clipping limit, in sigma units, used when performing fit, default=3</span>
<span class="n">fit_geom</span> <span class="o">=</span><span class="s1">&#39;rshift&#39;</span> <span class="c1"># ftype of affine transformation to be considered when fitting catalogs, default=&#39;general&#39;</span>
<span class="n">use2dhist</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># boolean indicating whether to use 2D histogram to find initial offset, default=True</span>
<span class="n">search_radius</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># radius in arcseconds to search for a match</span>
<span class="n">tol</span> <span class="o">=</span> <span class="mf">1.0</span>  <span class="c1"># Matching tolerance for xyxymatch in arcsec. (Default=1.0)</span>
<span class="n">use2dhist</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># boolean indicating whether to use 2D histogram to find initial offset, default=True</span>
   
<span class="n">pipe3</span><span class="o">=</span><span class="n">Image3Pipeline</span><span class="p">()</span>    
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">kernel_fwhm</span> <span class="o">=</span> <span class="n">fwhm</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">snr_threshold</span> <span class="o">=</span> <span class="n">snr</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">minobj</span> <span class="o">=</span> <span class="n">minobj</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">fitgeometry</span> <span class="o">=</span> <span class="n">fit_geom</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">use2dhist</span> <span class="o">=</span> <span class="n">use2dhist</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">save_catalogs</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#pipe3.tweakreg.skip = True        # test to see if this affects the final output</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">outlier_detection</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">source_catalog</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#pipe3.output_dir = datadir</span>

<span class="c1"># run Image3</span>

<span class="c1">#im = pipe3.run(rtdata.input)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">pipe3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_asnfile.json&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image 3 pipeline finished.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id2">
<h3>Go through list of individual images and see which sources were found for each image.<a class="headerlink" href="#id2" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Get list of catalogs</span>

<span class="n">cataloglist</span> <span class="o">=</span> <span class="p">[</span><span class="n">ele</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;cal.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;cal_cat.ecsv&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">ele</span> <span class="ow">in</span> <span class="n">imagelist</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="n">imagelist</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="n">cataloglist</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Loop through each image and overplot the sources found in the individual catalogs</span>

<span class="n">index</span><span class="o">=</span><span class="mi">0</span>
<span class="k">for</span> <span class="n">cal_image</span> <span class="ow">in</span> <span class="n">imagelist</span><span class="p">:</span>
    <span class="n">indimage</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="n">cal_image</span><span class="p">)</span>
    <span class="n">ind_data</span> <span class="o">=</span> <span class="n">indimage</span><span class="o">.</span><span class="n">data</span>
    
    <span class="n">indcat</span> <span class="o">=</span> <span class="n">cataloglist</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">catdata</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">indcat</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="n">comment</span><span class="o">=</span><span class="s1">&#39;#&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cal_image</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">indcat</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">catdata</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">]),</span> <span class="s1">&#39;sources found&#39;</span><span class="p">)</span>
    
    <span class="c1"># mark sources on image frame to see if the correct sources were found</span>
    <span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
    <span class="c1"># keep image stretch in mind for plotting. sky subtracted range ~ (-15, 10), single sample ~ (0, 20)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ind_data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span><span class="c1">#, norm=norm)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">catdata</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">catdata</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">],</span><span class="n">lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">index</span><span class="o">+</span><span class="mi">1</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="id3">
<h3>Look at positions of RA, Dec and get stats on differences for the combined image run with tweakreg on<a class="headerlink" href="#id3" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">im</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_combined_i2d.fits&#39;</span><span class="p">)</span>
<span class="n">pixarea</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">pixelarea_steradians</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pixel area in steradians&#39;</span><span class="p">,</span> <span class="n">pixarea</span><span class="p">)</span>

<span class="c1"># pull out data portion of input file</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># print stats on input image</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image mean, median and std&#39;</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run DAOStarFinder to find sources in image</span>

<span class="n">ap_radius</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># radius for aperture for centroiding and photometry</span>

<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>    <span class="c1"># default threshold=5*std, fwhm=3</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>    

<span class="c1"># Create apertures for x,y positions</span>
<span class="n">positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="c1">#print(positions)</span>

<span class="c1">#positions = (sources[&#39;xcentroid&#39;], sources[&#39;ycentroid&#39;])</span>
<span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">)</span>

<span class="c1"># using wcs info from images, put coordinates into RA, Dec</span>
<span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of sources found with DAOStarFinder: &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ra</span><span class="p">))</span>

<span class="c1"># add RA, Dec to sources table</span>

<span class="n">ra_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ra</span><span class="p">)</span>
<span class="n">dec_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">ra_col</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">dec_col</span><span class="p">)</span>

<span class="c1"># print RA, Dec for each x, y position found</span>
<span class="c1">#print(sources[&#39;xcentroid&#39;, &#39;ycentroid&#39;, &#39;RA&#39;, &#39;Dec&#39;])  </span>

<span class="n">sources_sub</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
<span class="n">sources_sub</span><span class="o">.</span><span class="n">pprint_all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Put ra, dec coords into a table</span>
<span class="n">cat1_sim</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">RA_sim</span><span class="p">,</span> <span class="n">Dec_sim</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
<span class="n">cat2_calc</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    
<span class="c1"># Get coordinates with SkyCoord for each catalog</span>
    
<span class="n">coord_cat1_sim</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
<span class="n">coord_cat2_calc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>    
<span class="n">ind_cat2_cat1</span><span class="p">,</span> <span class="n">dist_2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">coord_cat1_sim</span><span class="p">,</span> <span class="n">coord_cat2_calc</span><span class="p">)</span>
    
<span class="c1"># Find where the catalogs match</span>
    
<span class="n">cat1_matched</span> <span class="o">=</span> <span class="n">cat1_sim</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]</span>
<span class="n">cat2_matched</span> <span class="o">=</span> <span class="n">cat2_calc</span><span class="p">[</span><span class="n">ind_cat2_cat1</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]]</span>
    
<span class="c1">#print(cat1_matched)</span>
    
<span class="c1"># Get differences in RA, Dec</span>
<span class="n">ra_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
<span class="n">dec_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> 
    
<span class="c1">#print(ra_diff)</span>
    
<span class="c1"># put differences in milliarcseconds</span>
<span class="n">ra_diff</span> <span class="o">=</span> <span class="n">ra_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
<span class="n">dec_diff</span> <span class="o">=</span> <span class="n">dec_diff</span> <span class="o">*</span> <span class="mi">3600000</span>

<span class="n">deltara_twon</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">deltadec_twon</span> <span class="o">=</span> <span class="p">[]</span>
    
<span class="c1"># Compare input RA, Dec to found RA, Dec</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;</span><span class="p">)</span>
<span class="c1"># Find if the differences are within the allowed 30 mas range</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">)):</span>
    <span class="c1">#if ra_diff[i] &lt; 30 and dec_diff[i] &lt; 30:</span>
    <span class="n">deltara_twon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">deltadec_twon</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span> 
        <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;pass&#39;</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">))</span>
 
    
<span class="c1"># Plot ra and dec differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s1">&#39;Differences in RA and Dec in milliarcseconds&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Delta RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Delta Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">deltara_twon</span><span class="p">,</span><span class="n">deltadec_twon</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot should show no differences greater than 30 milliarcseconds  </span>

<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of sources matched: &#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">deltara_twon</span><span class="p">))</span>
<span class="c1"># Plot ra and dec differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s1">&#39;Differences in RA and Dec in milliarcseconds&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Delta RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Delta Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">deltadec_twon</span><span class="p">,</span><span class="n">deltara_twon</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot should show no differences greater than 30 milliarcseconds      </span>

    
<span class="n">meanRAdiff_twon</span><span class="p">,</span> <span class="n">medianRAdiff_twon</span><span class="p">,</span> <span class="n">stdRAdiff_twon</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">deltara_twon</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="n">meanDecdiff_twon</span><span class="p">,</span> <span class="n">medianDecdiff_twon</span><span class="p">,</span> <span class="n">stdDecdiff_twon</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">deltadec_twon</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanRAdiff_twon</span><span class="p">,</span> <span class="n">medianRAdiff_twon</span><span class="p">,</span> <span class="n">stdRAdiff_twon</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanDecdiff_twon</span><span class="p">,</span> <span class="n">medianDecdiff_twon</span><span class="p">,</span> <span class="n">stdDecdiff_twon</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mark sources on image frame to see if the correct sources were found</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
<span class="c1"># keep image stretch in mind for plotting. sky subtracted range ~ (-15, 10), single sample ~ (0, 20)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="c1">#, norm=norm)</span>
<span class="n">apertures</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="c1">#, alpha=0.5)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Take a closer look at a portion of the image to get a closer look at the psf</span>

<span class="c1"># mark sources on image frame to see if the correct sources were found</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
<span class="c1"># keep image stretch in mind for plotting. sky subtracted range ~ (-15, 10), single sample ~ (0, 20)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">350</span><span class="p">:</span><span class="mi">450</span><span class="p">,</span> <span class="mi">700</span><span class="p">:</span><span class="mi">820</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><span class="c1">#, norm=norm)</span>
<span class="c1">#apertures.plot(color=&#39;red&#39;, lw=2.5) #, alpha=0.5)</span>
<span class="c1">#plt.scatter(sources[&#39;xcentroid&#39;]-700, sources[&#39;ycentroid&#39;]-350, color=&#39;red&#39;)</span>
<span class="c1">#plt.ylim(350,450)</span>
<span class="c1">#plt.xlim(700,820)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="test-again-with-tweakreg-off">
<h3>Test again with tweakreg off<a class="headerlink" href="#test-again-with-tweakreg-off" title="Permalink to this headline">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run Calwebb_image3 on the association table with tweakreg on</span>
    
<span class="c1"># set any specific parameters</span>
<span class="c1"># tweakreg parameters to allow data to run</span>
<span class="n">fwhm</span> <span class="o">=</span> <span class="mf">3.318</span> <span class="c1">#3.27  # Gaussian kernel FWHM of objects expected, default=2.5</span>
<span class="n">minobj</span> <span class="o">=</span> <span class="mi">5</span>  <span class="c1"># minimum number of objects needed to match positions for a good fit, default=15</span>
<span class="n">snr</span> <span class="o">=</span> <span class="mi">40</span> <span class="c1"># signal to noise threshold, default=5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># clipping limit, in sigma units, used when performing fit, default=3</span>
<span class="n">fit_geom</span> <span class="o">=</span><span class="s1">&#39;rshift&#39;</span> <span class="c1"># ftype of affine transformation to be considered when fitting catalogs, default=&#39;general&#39;</span>
<span class="n">use2dhist</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># boolean indicating whether to use 2D histogram to find initial offset, default=True</span>
   
<span class="c1">#pipe3=Image3Pipeline()    </span>
<span class="c1">#pipe3.tweakreg.kernel_fwhm = fwhm</span>
<span class="c1">#pipe3.tweakreg.snr_threshold = snr</span>
<span class="c1">#pipe3.tweakreg.minobj = minobj</span>
<span class="c1">#pipe3.tweakreg.sigma = sigma</span>
<span class="c1">#pipe3.tweakreg.fitgeometry = fit_geom</span>
<span class="c1">#pipe3.tweakreg.use2dhist = use2dhist</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">tweakreg</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>        <span class="c1"># test to see if this affects the final output</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">outlier_detection</span><span class="o">.</span><span class="n">skip</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">source_catalog</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">pipe3</span><span class="o">.</span><span class="n">save_results</span> <span class="o">=</span> <span class="kc">True</span>
<span class="c1">#pipe3.output_dir = datadir</span>

<span class="c1"># run Image3</span>

<span class="c1">#im = pipe3.run(rtdata.input)</span>
<span class="n">image</span> <span class="o">=</span> <span class="n">pipe3</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_asnfile.json&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image 3 pipeline finished.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">im</span> <span class="o">=</span> <span class="n">ImageModel</span><span class="p">(</span><span class="s1">&#39;starfield_50star4ptdither_combined_i2d.fits&#39;</span><span class="p">)</span>
<span class="n">pixarea</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">photometry</span><span class="o">.</span><span class="n">pixelarea_steradians</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Pixel area in steradians&#39;</span><span class="p">,</span> <span class="n">pixarea</span><span class="p">)</span>

<span class="c1"># pull out data portion of input file</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">data</span>

<span class="c1"># print stats on input image</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">200.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image mean, median and std&#39;</span><span class="p">,</span><span class="n">mean</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Run DAOStarFinder to find sources in image</span>

<span class="n">ap_radius</span> <span class="o">=</span> <span class="mf">5.</span>  <span class="c1"># radius for aperture for centroiding and photometry</span>

<span class="n">daofind</span> <span class="o">=</span> <span class="n">DAOStarFinder</span><span class="p">(</span><span class="n">fwhm</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">10.</span><span class="o">*</span><span class="n">std</span><span class="p">)</span>    <span class="c1"># default threshold=5*std, fwhm=3</span>
<span class="n">sources</span> <span class="o">=</span> <span class="n">daofind</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>    

<span class="c1">#sources.pprint_all()</span>
<span class="c1">#print(sources[&#39;xcentroid&#39;,&#39;ycentroid&#39;,&#39;peak&#39;])   </span>

<span class="c1"># Create apertures for x,y positions</span>
<span class="n">positions</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">]))</span>
<span class="c1">#print(positions)</span>

<span class="c1">#positions = (sources[&#39;xcentroid&#39;], sources[&#39;ycentroid&#39;])</span>
<span class="n">apertures</span> <span class="o">=</span> <span class="n">CircularAperture</span><span class="p">(</span><span class="n">positions</span><span class="p">,</span> <span class="n">r</span><span class="o">=</span><span class="n">ap_radius</span><span class="p">)</span>


<span class="c1"># using wcs info from images, put coordinates into RA, Dec</span>
<span class="n">ra</span><span class="p">,</span> <span class="n">dec</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">meta</span><span class="o">.</span><span class="n">wcs</span><span class="p">(</span><span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">],</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;ycentroid&#39;</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Number of sources found with DAOStarFinder: &#39;</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">ra</span><span class="p">))</span>
<span class="c1"># add RA, Dec to sources table</span>

<span class="n">ra_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">ra</span><span class="p">)</span>
<span class="n">dec_col</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Dec&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">dec</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">ra_col</span><span class="p">)</span>
<span class="n">sources</span><span class="o">.</span><span class="n">add_column</span><span class="p">(</span><span class="n">dec_col</span><span class="p">)</span>

<span class="c1"># print RA, Dec for each x, y position found</span>
<span class="c1">#print(sources[&#39;xcentroid&#39;, &#39;ycentroid&#39;, &#39;RA&#39;, &#39;Dec&#39;])  </span>

<span class="n">sources_sub</span> <span class="o">=</span> <span class="n">sources</span><span class="p">[</span><span class="s1">&#39;xcentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;ycentroid&#39;</span><span class="p">,</span> <span class="s1">&#39;RA&#39;</span><span class="p">,</span> <span class="s1">&#39;Dec&#39;</span><span class="p">]</span>
<span class="n">sources_sub</span><span class="o">.</span><span class="n">pprint_all</span><span class="p">()</span>
<span class="nb">print</span><span class="p">()</span>

<span class="c1"># Compare input RA, Dec to found RA, Dec</span>
<span class="c1">#print(&#39;       RA found       Dec found    RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;)</span>

<span class="n">deltara_twoff</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">deltadec_twoff</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># Put ra, dec coords into a table</span>
<span class="n">cat1_sim</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">RA_sim</span><span class="p">,</span> <span class="n">Dec_sim</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
<span class="n">cat2_calc</span> <span class="o">=</span> <span class="n">Table</span><span class="p">([</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="s1">&#39;dec&#39;</span><span class="p">))</span>
    
<span class="c1"># Get coordinates with SkyCoord for each catalog</span>
    
<span class="n">coord_cat1_sim</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat1_sim</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>
<span class="n">coord_cat2_calc</span> <span class="o">=</span> <span class="n">SkyCoord</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">],</span> <span class="n">dec</span><span class="o">=</span><span class="n">cat2_calc</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">],</span> <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;deg&quot;</span><span class="p">)</span>    
<span class="n">ind_cat2_cat1</span><span class="p">,</span> <span class="n">dist_2d</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">match_coordinates_sky</span><span class="p">(</span><span class="n">coord_cat1_sim</span><span class="p">,</span> <span class="n">coord_cat2_calc</span><span class="p">)</span>
    
<span class="c1"># Find where the catalogs match</span>
    
<span class="n">cat1_matched</span> <span class="o">=</span> <span class="n">cat1_sim</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]</span>
<span class="n">cat2_matched</span> <span class="o">=</span> <span class="n">cat2_calc</span><span class="p">[</span><span class="n">ind_cat2_cat1</span><span class="p">[</span><span class="n">dist_2d</span><span class="o">.</span><span class="n">arcsec</span><span class="o">&lt;</span><span class="mf">0.05</span><span class="p">]]</span>
    
<span class="c1">#print(cat1_matched)</span>
    
<span class="c1"># Get differences in RA, Dec</span>
<span class="n">ra_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
<span class="n">dec_diff</span> <span class="o">=</span> <span class="n">cat2_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">cat1_matched</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span> 
    
<span class="c1">#print(ra_diff)</span>
    
<span class="c1"># put differences in milliarcseconds</span>
<span class="n">ra_diff</span> <span class="o">=</span> <span class="n">ra_diff</span> <span class="o">*</span> <span class="mi">3600000</span>
<span class="n">dec_diff</span> <span class="o">=</span> <span class="n">dec_diff</span> <span class="o">*</span> <span class="mi">3600000</span>

    
<span class="c1"># Compare input RA, Dec to found RA, Dec</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA_Diff (mas)  Dec_diff (mas) pass/fail&#39;</span><span class="p">)</span>
<span class="c1"># Find if the differences are within the allowed 30 mas range</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">)):</span>
    <span class="c1">#if ra_diff[i] &lt; 30 and dec_diff[i] &lt; 30:</span>
    <span class="n">deltara_twoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">deltadec_twoff</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span> <span class="ow">and</span> <span class="nb">abs</span><span class="p">(</span><span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span> 
        <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;pass&#39;</span> 
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">test</span> <span class="o">=</span> <span class="s1">&#39;fail&#39;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{:15.6f}</span><span class="s1"> </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ra_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">dec_diff</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">test</span><span class="p">))</span>
 
    
<span class="c1"># Plot ra and dec differences</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span> <span class="p">(</span><span class="s1">&#39;Differences in RA and Dec in milliarcseconds&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Delta RA&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Delta Dec&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">deltara_twoff</span><span class="p">,</span><span class="n">deltadec_twoff</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot should show no differences greater than 30 milliarcseconds </span>

<span class="nb">print</span><span class="p">()</span>
    
<span class="n">meanRAdiff_twoff</span><span class="p">,</span> <span class="n">medianRAdiff_twoff</span><span class="p">,</span> <span class="n">stdRAdiff_twoff</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">deltara_twoff</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>
<span class="n">meanDecdiff_twoff</span><span class="p">,</span> <span class="n">medianDecdiff_twoff</span><span class="p">,</span> <span class="n">stdDecdiff_twoff</span> <span class="o">=</span> <span class="n">sigma_clipped_stats</span><span class="p">(</span><span class="n">deltadec_twoff</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">maxiters</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>  <span class="c1"># default sigma=3</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanRAdiff_twoff</span><span class="p">,</span> <span class="n">medianRAdiff_twoff</span><span class="p">,</span> <span class="n">stdRAdiff_twoff</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std (units in mas)&#39;</span><span class="p">,</span><span class="n">meanDecdiff_twoff</span><span class="p">,</span> <span class="n">medianDecdiff_twoff</span><span class="p">,</span> <span class="n">stdDecdiff_twoff</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># mark sources on image frame to see if the correct sources were found</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
<span class="c1"># keep image stretch in mind for plotting. sky subtracted range ~ (-15, 10), single sample ~ (0, 20)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span><span class="c1">#, norm=norm)</span>
<span class="n">apertures</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;red&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.5</span><span class="p">)</span> <span class="c1">#, alpha=0.5)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Take a closer look at a portion of the image to get a closer look at the psf</span>

<span class="c1"># mark sources on image frame to see if the correct sources were found</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">ImageNormalize</span><span class="p">(</span><span class="n">stretch</span><span class="o">=</span><span class="n">SqrtStretch</span><span class="p">())</span>
<span class="c1"># keep image stretch in mind for plotting. sky subtracted range ~ (-15, 10), single sample ~ (0, 20)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">350</span><span class="p">:</span><span class="mi">450</span><span class="p">,</span> <span class="mi">700</span><span class="p">:</span><span class="mi">820</span><span class="p">],</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;Greys&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span><span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span><span class="c1">#, norm=norm)</span>

<span class="c1">#plt.scatter(sources[&#39;xcentroid&#39;]-700, sources[&#39;ycentroid&#39;]-350, color=&#39;red&#39;)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Compare stats across tests:</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;All units are milliarcseconds for statistics&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Statistics on differences between RA and Dec in individual calibrated files&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanRAdiff_cal</span><span class="p">,</span> <span class="n">medianRAdiff_cal</span><span class="p">,</span> <span class="n">stdRAdiff_cal</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanDecdiff_cal</span><span class="p">,</span> <span class="n">medianDecdiff_cal</span><span class="p">,</span> <span class="n">stdDecdiff_cal</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="c1">#print(&#39;Statistics on differences between RA and Dec in individual i2d files when run with tweakreg on&#39;)</span>
<span class="c1">#print(&#39;RA difference mean, median and std&#39;,meanRAdiff_i2d, medianRAdiff_i2d, stdRAdiff_i2d) </span>
<span class="c1">#print(&#39;Dec difference mean, median and std&#39;,meanDecdiff_i2d, medianDecdiff_i2d, stdDecdiff_i2d)</span>
<span class="c1">#print()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Statistics on differences between RA and Dec in combined i2d file when run with tweakreg on&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanRAdiff_twon</span><span class="p">,</span> <span class="n">medianRAdiff_twon</span><span class="p">,</span> <span class="n">stdRAdiff_twon</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanDecdiff_twon</span><span class="p">,</span> <span class="n">medianDecdiff_twon</span><span class="p">,</span> <span class="n">stdDecdiff_twon</span><span class="p">)</span>
<span class="nb">print</span><span class="p">()</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Statistics on differences between RA and Dec in combined i2d file when run with tweakreg off&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;RA difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanRAdiff_twoff</span><span class="p">,</span> <span class="n">medianRAdiff_twoff</span><span class="p">,</span> <span class="n">stdRAdiff_twoff</span><span class="p">)</span> 
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Dec difference mean, median and std&#39;</span><span class="p">,</span><span class="n">meanDecdiff_twoff</span><span class="p">,</span> <span class="n">medianDecdiff_twoff</span><span class="p">,</span> <span class="n">stdDecdiff_twoff</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="criteria-for-success">
<h3>Criteria for success.<a class="headerlink" href="#criteria-for-success" title="Permalink to this headline">#</a></h3>
<p>If the first set of images with no shift are well aligned as shown in images and the statistical comparison, that test passes.</p>
<p>Once a shift is added, the statistics and number of sources found don’t tell the whole story. Look at the combined images shown after image3 with and without tweakreg. If the image run with tweakreg shows double sources just like the image without tweakreg, then the test fails. If the image doesn’t show double sources and looks like the unshifted combined image, then the test passes. Examine the image to look for obvious faults like stars that were not identified as stars, those with multiple star identifications, double star images, etc.</p>
<section id="about-this-notebook">
<h4>About this Notebook<a class="headerlink" href="#about-this-notebook" title="Permalink to this headline">#</a></h4>
<p>Authors: M. Cracraft, M. Libralato and K. Gordon, MIRI Branch</p>
<p>Updated On: 08/25/2021</p>
</section>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "TheRealZoidberg/jwst_validation_test",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./notebooks/tweakreg/jwst_tweakreg_miri_test"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="exec_jwst_tweakreg_miri_test.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">JWST Pipeline Validation Testing Notebook: Calwebb_Image3, Tweakreg step with MIRI imaging</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="../../outlier_detection/jwst_outlier_detection_miri_test/exec_jwst_outlier_detection_miri_test.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">JWST Pipeline Validation Notebook: outlier_detection with MIRI</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By STScI<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>